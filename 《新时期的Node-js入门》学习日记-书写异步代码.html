<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">ã€Šæ–°æ—¶æœŸçš„Node.jså…¥é—¨ã€‹å­¦ä¹ æ—¥è®°-ä¹¦å†™å¼‚æ­¥ä»£ç  | 0xGeekCat</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * é‚®ç®±ä¿¡æ¯ä¹‹ç±»çš„ä¸œè¥¿å¯ä»¥å¡«åœ¨è¿™é‡Œï¼Œè¿™äº›jså˜é‡åŸºæœ¬éƒ½ä½œç”¨äºsakura-app.js
   * è¿™æ ·çš„è®¾ç½®ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨åŸºäºPHPå¼€å‘çš„ä¸»é¢˜ä¸­è®¾ç½®jså˜é‡ï¼Œæ—¢ç„¶ç§»æ¤åˆ°äº†Nodeä¸Šï¼Œæˆ‘æƒ³æˆ–è®¸å¯ä»¥ç²¾ç®€è¿™ä¸€é€»è¾‘å§
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "MĞ°ĞºÑĞ¸Ğ¼0xGeekCat";
  mashiro_option.author_name = "0xGeekCat";
  mashiro_option.site_url = "https://0xgeekcat.github.io/";
  mashiro_option.v_appId = "GyC3NzMvd0hT9Yyd2hYIC0MN-gzGzoHsz";
  mashiro_option.v_appKey = "mgOpfzbkHYqU92CV4IDlAUHQ";
  mashiro_option.mathjax = "0";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/images/Konachan.com%20ls%20black_hair%20f%20toriki%20touhou.jpg,https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/images/Konachan.com-293503-ghostblade-long_hair-red_hair-sword-tagme_character-thighhighs-weapon-wlop-scaled.jpg,https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/images/Konachan.com-298784-aeolian_wlop-barefoot-black_hair-braids-ghostblade-headdress-long_hair-ponytail-wlop-scaled.jpg,https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/images/Konachan.com%20-%20227403%20black_hair%20ghostblade%20jade_(wlop)%20japanese_clothes%20kimono%20logo%20realistic%20short_hair%20tattoo%20umbrella%20wlop.jpg,https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/images/Konachan.com-281267-aeolian_wlop-black_hair-bow_weapon-close-ghostblade-green_eyes-logo-long_hair-realistic-watermark-weapon-wink-wlop-scaled.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('æœ‹å‹ï¼ŒIEæµè§ˆå™¨æœªé€‚é…å“¦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dim">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <a href="https://0xgeekcat.github.io/">
          <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/custom/avatar.jpg">
        </a>
      </div>
      <div class="header-info">
        <p>ç”¨æ¥è®°å½•æˆ‘å¤§å­¦æœ€åç”Ÿæ¶¯ç ´é‡œæ²‰èˆŸåŠ›æŒ½ç‹‚æ¾œçš„ç–¯ç‹‚å­¦ä¹ å†ç¨‹</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/0xGeekCat" target="_blank" class="social-github" title="github">
                    <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/social/github.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=1292881925@qq.com" target="_blank" class="social-github" title="email">
                    <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/social/email.svg">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/social/wechat.png">
                  </a>
                  <div class="wechatInner">
                    <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/custom/wechat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">MĞ°ĞºÑĞ¸Ğ¼</span>
            <span class="shironeko">0xGeekCat</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    é¦–é¡µ
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    å½’æ¡£
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          æŠ€æœ¯
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E7%94%9F%E6%B4%BB/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          ç”Ÿæ´»
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          è½¬è½½
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
                    ä¹¦å•
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/%E5%B7%B2%E8%AF%BB/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          å·²è¯»
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/%E6%9C%AA%E8%AF%BB/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          æœªè¯»
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
                    å…³äº
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          æˆ‘ï¼Ÿ
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- å¥—åµŒç›®å½•ä½¿ç”¨ï¼ˆä¸»è¦ä¸ºäº†æ”¯æ´è¯„è®ºï¼‰-->
        
          <header class="entry-header">
            <h1 class="entry-title">ã€Šæ–°æ—¶æœŸçš„Node.jså…¥é—¨ã€‹å­¦ä¹ æ—¥è®°-ä¹¦å†™å¼‚æ­¥ä»£ç </h1>
            <p class="entry-census">0xGeekCat&nbsp;Â·&nbsp;2020-8-31&nbsp;Â·&nbsp;<span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»</p></p>

            <hr>
          </header>
        
        <div class="entry-content">
          <p>ğŸ‘‡<strong>å°è£…readFileçš„readæ–¹æ³•</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function read(path) {
    fs.readFile(path, function (err, data) {
        console.log(data.toString())
    })
}

read(&#39;foo.txt&#39;)
read(&#39;bar.txt&#39;)
read(&#39;baz.txt&#39;)</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot.png" alt="screenshot"></p>
<p>è°ƒç”¨<code>read</code>æ–¹æ³•è¯»å–å¤šä¸ªæ–‡ä»¶æ¯æ¬¡è¾“å‡ºç»“æœéƒ½ä¸åŒ</p>
<p>ä½†æœ‰æ—¶éœ€è¦ä¾èµ–ä¸Šä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå‡è®¾<code>foo.txt</code>æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢æœ‰ç”¨æ¥è§£å¯†çš„<code>key</code>ï¼Œéœ€è¦æ‹¿åˆ°<code>key</code>æ‰èƒ½è§£å¯†<code>bar.txt</code>é‡Œé¢çš„æ–‡æœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¸èƒ½è¿™æ ·ä½¿ç”¨<code>read</code>æ–¹æ³•</p>
<p><strong>æš‚ä¸”ä¸è€ƒè™‘<code>readFileSync</code>çš„æƒ…å†µä¸‹ä¸€èˆ¬ä¼šä½¿ç”¨åµŒå¥—çš„å›è°ƒå‡½æ•°</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function read(path1, path2, path3) {
    fs.readFile(path1, function (err, data) {
        console.log(data.toString())
        fs.readFile(path2, function (err, data) {
            console.log(data.toString())
            fs.readFile(path3, function (err, data) {
                console.log(data.toString())
            })
        })
    })
}

read(&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;)</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%201.png" alt="screenshot 1"></p>
<p>å°†ä¸‹ä¸€ä¸ªå¼‚æ­¥æ“ä½œæ”¾åˆ°ä¸Šä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å›è°ƒæ–¹æ³•ä¸­ï¼Œè¿™æ ·è™½ç„¶èƒ½ä¿è¯æ‰§è¡Œæ˜¯ä¸²è¡Œçš„ï¼Œä½†å½“ä»£ç åµŒå¥—çš„å±‚æ•°å¢åŠ ï¼Œä»£ç çš„å±‚æ¬¡ç»“æ„å°±ä¼šå˜å¾—ä¸æ¸…æ™°å¹¶ä¸”éš¾ä»¥ç»´æŠ¤</p>
<p><strong>å›è°ƒåœ°ç‹±</strong><code>callback hell</code>å°±è¢«ç”¨æ¥æè¿°è¿™ç§å†™æ³•ã€‚å®ƒæœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œåªæ˜¯å› ä¸ºä¸åˆ©äºå¼€å‘è€…é˜…è¯»å’Œç»´æŠ¤æ‰ä¼šé­åˆ°æ‘’å¼ƒ</p>
<h1 id="å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼"><a href="#å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼" class="headerlink" title="å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼"></a>å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼</h1><p>â“å‡è®¾ä¸€ä¸ªæ–¹æ³•å°è£…äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œé‚£å¦‚ä½•èƒ½æ‹¿åˆ°è¿”å›å€¼</p>
<p>ç¾å¥½çš„æ„¿æœ›æ˜¯ç›´æ¥æ‹¿åˆ°å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼</p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function read(path) {
    fs.readFile(path, function (err, data) {
        return data
    })
}

var data = read(&#39;foo.txt&#39;)
console.log(data) // undefined</code></pre>
<p>ç„¶è€Œç›´æ¥è°ƒç”¨<code>read</code>æ–¹æ³•ä¸ä¼šå¾—åˆ°ä»»ä½•è¿”å›å€¼ï¼Œ<code>data</code>æ‰“å°å‡ºæ¥ä¹Ÿæ˜¯<code>undefined</code></p>
<p><strong>ğŸ””åŸå› æ˜¯<code>read</code>æ–¹æ³•ä¼šå…ˆäºå†…éƒ¨çš„å›è°ƒå‡½æ•°è¿”å›ï¼Œå³å›è°ƒå‡½æ•°å†…éƒ¨çš„<code>return</code>å…³é”®å­—ä¸ä¼šå°†å€¼è¿”å›åˆ°å¤–éƒ¨</strong></p>
<h1 id="ç»„ç»‡å›è°ƒæ–¹æ³•"><a href="#ç»„ç»‡å›è°ƒæ–¹æ³•" class="headerlink" title="ç»„ç»‡å›è°ƒæ–¹æ³•"></a>ç»„ç»‡å›è°ƒæ–¹æ³•</h1><h2 id="å›è°ƒä¸CPS"><a href="#å›è°ƒä¸CPS" class="headerlink" title="å›è°ƒä¸CPS"></a>å›è°ƒä¸CPS</h2><p>å½“å¼€å‘è€…åˆšå¼€å§‹æ¥è§¦å›è°ƒæ—¶ï¼Œé€šå¸¸éƒ½ä¼šå†™æˆğŸ‘‡çš„æ ·å¼</p>
<pre><code class="javascript">function foo(args, function(err, data) {
    // todo
}) </code></pre>
<p>å¦‚æœå¯¹äºå¤šä¸ªåŠŸèƒ½ç›¸åŒçš„å¼‚æ­¥æ“ä½œï¼Œå®ƒä»¬çš„å›è°ƒå‡½æ•°éƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·çš„å†™æ³•ä¼šäº§ç”Ÿå¾ˆå¤šåŠŸèƒ½é‡å¤çš„ä»£ç </p>
<p>å¦ä¸€ç§åšæ³•æ˜¯<strong>å°†å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’</strong>ï¼Œè¿™é€šå¸¸è¢«ç§°ä¸º<strong>å»¶ç»­ä¼ é€’æ–¹å¼</strong><code>Continuation Passing Style</code>ï¼Œ<code>CPS</code>çš„æœ¬è´¨ä»ç„¶æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°</p>
<p><strong>CPSé£æ ¼çš„å›è°ƒ</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

var callback = function (err, data) {
    if (err) {
        console.log(err)
        return
    }
    console.log(data.toString())
}

fs.readFile(&#39;foo.txt&#39;, callback)</code></pre>
<p>å¦‚æœéœ€è¦è°ƒç”¨<code>readFile</code>æ–¹æ³•å¤šæ¬¡ï¼Œå¹¶ä¸”å®ƒä»¬çš„å›è°ƒæ–¹æ³•éƒ½ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œ<code>CPS</code>å¯ä»¥çœå»ä¸€äº›é‡å¤ä»£ç </p>
<p><code>CPS</code>å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³å›è°ƒåµŒå¥—çš„é—®é¢˜</p>
<p><strong>ğŸ‘‡ä½¿ç”¨CPSæ¥å¤„ç†å¤šä¸ªå›è°ƒ</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function callback1 (err, data) {
    if (err) {
        console.log(err)
    } else {
        console.log(data)
        fs.readFile(&#39;bar.txt&#39;, callback2)
    }
}

function callback2 (err, data) {
    if (err) {
        console.log(err)
    } else {
        console.log(data)
        fs.readFile(&#39;baz.txt&#39;, callback3)
    }
}

function callback3 (err, data) {
    if (err) {
        console.log(err)
    } else {
        console.log(data)
    }
}

fs.readFile(&#39;foo.txt&#39;, callback1)</code></pre>
<p>è¿™æ˜¯ä¹‹å‰åµŒå¥—å›è°ƒçš„å¦ä¸€ç§å†™æ³•ï¼Œå…¶æœ¬è´¨ä¸Šä»ç„¶æ˜¯åœ¨å›è°ƒä¸­è°ƒç”¨ä¸‹ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œåªæ˜¯é¿å…äº†å¤šä¸ªå›è°ƒå‡½æ•°åœ¨å½¢å¼ä¸ŠåµŒå¥—åœ¨ä¸€èµ·</p>
<p>è™½ç„¶æ¯”åµŒå¥—è°ƒç”¨çœ‹èµ·æ¥ç¾è§‚äº†ä¸€äº›ï¼Œä½†ä»ç„¶æ˜¾å¾—å†—é•¿ï¼Œè€Œä¸”ä¸šåŠ¡é€»è¾‘åˆ†æ•£åœ¨ä¸åŒçš„<code>callback</code>ä¸­ï¼Œåˆæ¬¡æ¥è§¦ä»£ç çš„å¼€å‘è€…ä¹Ÿä¸å®¹æ˜“ç†æ¸…å®ƒä»¬ä¹‹é—´çš„å…³ç³»</p>
<h2 id="ä½¿ç”¨asyncæ¨¡å—ç®€åŒ–å›è°ƒ"><a href="#ä½¿ç”¨asyncæ¨¡å—ç®€åŒ–å›è°ƒ" class="headerlink" title="ä½¿ç”¨asyncæ¨¡å—ç®€åŒ–å›è°ƒ"></a>ä½¿ç”¨asyncæ¨¡å—ç®€åŒ–å›è°ƒ</h2><p><code>async</code>æ˜¯ä¸€ä¸ªè‘—åçš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå®ƒçš„åˆè¡·ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å¤šä¸ªå¼‚æ­¥è°ƒç”¨åµŒå¥—çš„é—®é¢˜</p>
<h3 id="async-series"><a href="#async-series" class="headerlink" title="async.series"></a>async.series</h3><p><strong>ä½¿ç”¨seriesæ–¹æ³•å¤„ç†å¤šä¸ªå›è°ƒ</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)
var async = require(&#39;async&#39;)

function read_foo(callback) {
    fs.readFile(&#39;foo.txt&#39;, &#39;utf-8&#39;, callback)
}

function read_bar(callback) {
    fs.readFile(&#39;bar.txt&#39;, &#39;utf-8&#39;, callback)
}

function read_baz(callback) {
    fs.readFile(&#39;baz.txt&#39;, &#39;utf-8&#39;, callback)
}

async.series([read_foo, read_bar, read_baz], function (err, data) {
    console.log(data) // [ &#39;foo&#39;, &#39;bar&#39;, &#39;baz&#39; ]
})</code></pre>
<p><code>series</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†å…¨éƒ¨å¼‚æ­¥æ“ä½œçš„è¿”å›ç»“æœï¼Œç»“æœé›†ä¸­çš„é¡ºåºå’Œ<code>series</code>å‚æ•°æ•°ç»„çš„é¡ºåºæ˜¯å¯¹åº”çš„</p>
<p><strong>ğŸ””è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯åµŒå¥—å›è°ƒçš„è¯­æ³•ç³–ï¼Œæ‰€æœ‰çš„å¼‚æ­¥è°ƒç”¨éƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œå³æ‰§è¡Œå®Œä¸€ä¸ªæ“ä½œå†è¿›è¡Œä¸‹ä¸€ä¸ªæ“ä½œ</strong></p>
<h3 id="async-parallel"><a href="#async-parallel" class="headerlink" title="async.parallel"></a>async.parallel</h3><p>è°ƒç”¨æ–¹å¼å’Œå‚æ•°éƒ½ä¸<code>series</code>ç›¸åŒï¼Œä¹Ÿä¼šé¡ºåºè¿”å›æ‰€æœ‰çš„è°ƒç”¨ç»“æœï¼ŒåŒºåˆ«åœ¨äºæ‰€æœ‰çš„æ–¹æ³•æ˜¯å¹¶è¡Œæ‰§è¡Œï¼Œ<strong>æ‰§è¡Œæ—¶é—´ç”±è€—æ—¶æœ€é•¿çš„è°ƒç”¨å†³å®š</strong></p>
<p><code>parallel</code>æ–¹æ³•åœ¨æ•°ç»„ä¸­çš„æŸä¸ªå¼‚æ­¥è°ƒç”¨ç»“æŸä¹‹åå¹¶æ²¡æœ‰ç«‹åˆ»è¿”å›ï¼Œè€Œæ˜¯å°†ç»“æœæš‚å­˜èµ·æ¥ï¼Œç­‰æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œå®Œæˆä¹‹åï¼Œ<strong>å†æ ¹æ®è°ƒç”¨é¡ºåºå°†ç»“æœç»„è£…æˆé¡ºåºçš„ç»“æœé›†è¿”å›</strong></p>
<h3 id="async-waterfall"><a href="#async-waterfall" class="headerlink" title="async.waterfall"></a>async.waterfall</h3><p>åŒæ ·æ˜¯é¡ºåºæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå’Œå‰ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«æ˜¯<strong>æ¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œéƒ½ä¼šæŠŠç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªè°ƒç”¨</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)
var async = require(&#39;async&#39;)

function read_foo(callback) {
    fs.readFile(&#39;foo.txt&#39;, &#39;utf-8&#39;, callback)
}

function read_bar(value, callback) {
    console.log(&#39;ä¸Šä¸€ä¸ªæ“ä½œä¼ å…¥çš„å€¼&#39;, value)
    fs.readFile(&#39;bar.txt&#39;, &#39;utf-8&#39;, callback)
}

function read_baz(value, callback) {
    console.log(&#39;ä¸Šä¸€ä¸ªæ“ä½œä¼ å…¥çš„å€¼&#39;, value)
    fs.readFile(&#39;baz.txt&#39;, &#39;utf-8&#39;, callback)
}

async.waterfall([read_foo, read_bar, read_baz], function (err, data) {
    console.log(data)
})</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%202.png" alt="screenshot 2"></p>
<h3 id="async-map"><a href="#async-map" class="headerlink" title="async.map"></a>async.map</h3><p><code>map</code>å’Œä¸Šé¢çš„å‡ ä¸ªæ–¹æ³•ç¨æœ‰ä¸åŒï¼Œ<code>map</code>æ¥æ”¶ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œæ•°ç»„çš„å…ƒç´ ä¸æ˜¯æ–¹æ³•åè€Œæ˜¯æ–¹æ³•çš„å‚æ•°ï¼Œæ•°ç»„é‡Œçš„å€¼ä¼šä¾æ¬¡ä¼ é€’ç»™å®šä¹‰çš„å¼‚æ­¥æ–¹æ³•ï¼›<code>map</code>çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å¼‚æ­¥çš„æ–¹æ³•ï¼Œä¸éœ€è¦å†åšé¢å¤–å°è£…</p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)
var async = require(&#39;async&#39;)

var arr = [&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;]

async.map(arr, fs.readFile, function (err, results) {
    console.log(results.toString()) // foo,bar,baz
})</code></pre>
<p>ç„¶è€Œ<code>map</code>æ–¹æ³•æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œåªèƒ½æ¥å—ä¸‰ä¸ªå‚æ•°</p>
<ul>
<li>æ•°ç»„</li>
<li>å¯¹åº”çš„å¼‚æ­¥æ–¹æ³•</li>
<li>å›è°ƒå‡½æ•°</li>
</ul>
<p>ä»¥<code>readFile</code>ä¸ºä¾‹ï¼Œä¼šå‘ç°æ²¡æœ‰å¤šä½™çš„å‚æ•°æ¥å®šä¹‰ç¼–ç æ ¼å¼ï¼Œè¿™ç§æƒ…å†µä¸‹è¿˜æ˜¯éœ€è¦å¯¹<code>readFile</code>åšä¸€å±‚å°è£…</p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)
var async = require(&#39;async&#39;)

function myReadFile(path, callback) {
    fs.readFile(path, &#39;utf-8&#39;, callback)
}

var arr = [&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;]

async.map(arr, myReadFile, function (err, results) {
    console.log(results.toString())
})</code></pre>
<p><code>async</code>æ¨¡å—ä¸€åº¦æ˜¯ç®¡ç†å¼‚æ­¥è°ƒç”¨çš„é¦–é€‰ï¼Œç„¶è€Œå®ƒå¹¶ä¸é€‚ç”¨æ‰€æœ‰çš„åœºåˆ</p>
<p><strong><code>async</code>é€šå¸¸ä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥åŒ…å«æ‰€æœ‰çš„å¼‚æ­¥æ–¹æ³•æˆ–è€…è°ƒç”¨çš„å‚æ•°ï¼Œç„¶è€Œæœ‰æ—¶æ— æ³•åœ¨è°ƒç”¨å‰å°±å†³å®šå“ªäº›å¼‚æ­¥æ–¹æ³•ä¼šè¢«è°ƒç”¨</strong></p>
<h1 id="ä½¿ç”¨Promise"><a href="#ä½¿ç”¨Promise" class="headerlink" title="ä½¿ç”¨Promise"></a>ä½¿ç”¨Promise</h1><p>åœ¨Nodeä¸­ç‡å…ˆå¾—åˆ°å¹¿æ³›åº”ç”¨çš„æ˜¯<code>async</code>è¿™æ ·çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œasyncæ¨¡å—ä¸­æ²¡æœ‰åº”ç”¨ä»€ä¹ˆæ–°æ¦‚å¿µï¼Œåªæ˜¯å½¢å¼ä¸Šç®€åŒ–çš„è¯­æ³•ç³–ã€‚ç¤¾åŒºè‡ªç„¶ä¸ä¼šæ»¡è¶³æ­¢æ­¥äºæ­¤ï¼Œå¼€å‘è€…ä»¬æŠŠç›®å…‰æŠ•å‘äº†åˆ«å¤„ï¼Œå¸Œæœ›æœ‰ä¸€ç§æ–°çš„æ–¹å¼æ¥è§£å†³é—®é¢˜ï¼Œåœ¨è¿™ç§ç¯å¢ƒä¸‹<code>Promise</code>è¿›å…¥äº†è§†é‡</p>
<h2 id="Promiseçš„å†å²"><a href="#Promiseçš„å†å²" class="headerlink" title="Promiseçš„å†å²"></a>Promiseçš„å†å²</h2><p><code>Promise</code>æ¦‚å¿µæœ€æ—©å¯ä»¥è¿½æº¯åˆ°1976å¹´ï¼Œfutureã€promiseã€delayã€deferredè¿™å‡ ä¸ªè¯ç»å¸¸æ”¾åœ¨ä¸€å—è®¨è®ºï¼Œå®ƒä»¬éƒ½ç”¨æ¥æŒ‡ä»£ä¸€ä¸ªå¼€å§‹æ—¶çŠ¶æ€æœªçŸ¥çš„å¯¹è±¡</p>
<p>jQueryåœ¨1.5åŠä¹‹åçš„ç‰ˆæœ¬ä¸­å¢åŠ äº†<code>deferred</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯<code>Promise</code>çš„ä¸€ç§å®ç°ï¼Œå¹¶ä¸”éšç€jQueryæœ¬èº«æµè¡Œèµ·æ¥</p>
<p><strong>ğŸ‘‡æ™®é€šçš„Ajaxæ“ä½œ</strong></p>
<pre><code class="javascript">$.ajax({
   url: &quot;test.html&quot;,
   success: function () {
       alert(&#39;success&#39;)
   },
   error: function () {
       alert(&#39;fail&#39;)
   }
})</code></pre>
<p><code>success</code>å’Œ<code>fail</code>æ–¹æ³•éƒ½æ˜¯ä½œä¸ºå‚æ•°çš„ä¸€éƒ¨åˆ†ä¼ é€’ç»™<code>$.ajax()</code>æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯Ajaxæ‰§è¡Œå®Œæˆåçš„å›è°ƒå‡½æ•°</p>
<p>ğŸ‘‡ä½¿ç”¨<code>deferred</code>æ”¹å†™Ajax</p>
<pre><code class="javascript">$.ajax(&quot;test.html&quot;)
    .done(function (data) {
        alert(&#39;success&#39;)
    })
    .fail(function () {
        alert(&#39;fail&#39;)
    })</code></pre>
<p>ğŸ‘†ä¸¤æ®µä»£ç ç»“æ„ä¸Šæœ€å¤§çš„åŒºåˆ«æ˜¯ä½¿ç”¨<code>deferred</code>æ”¹å†™çš„<code>Ajax</code>æ–¹æ³•ï¼Œå°†<code>success</code>å’Œ<code>error</code>ä¸¤ä¸ªå›è°ƒå‡½æ•°ä»<code>$.ajax()</code>æ–¹æ³•ä¸­å‰¥ç¦»ï¼Œè€Œä¸”é“¾å¼è°ƒç”¨ä¹Ÿè¡¨æ˜<code>$.ajax(&quot;test.html&quot;)</code>å¼‚æ­¥æ–¹æ³•äº§ç”Ÿäº†è¿”å›å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¿›æ­¥ï¼Œç¦»æœ€å¼€å§‹çš„ç†æƒ³æ›´è¿‘ä¸€æ­¥</p>
<p>åé¢<code>Promise</code>æ¦‚å¿µå¾—åˆ°æ¨å¹¿å¹¶å‡ºäº†ä¸€äº›è§„èŒƒï¼Œä»¥<code>Promise/A+</code>æœ€ä¸ºå‡ºåï¼Œç¤¾åŒºä¹Ÿå‡ºç°äº†ä¸€äº›æ”¯æŒ<code>Promise</code>çš„ç¬¬ä¸‰æ–¹åº“ï¼Œåæ¥<code>Promise/A+</code>æ ‡å‡†è¢«ç¤¾åŒºæ¥å—ï¼Œ<code>ES2015</code>ä¸­çš„<code>Promise</code>å°±æ˜¯æŒ‰ç…§å®ƒæ¥å®ç°çš„</p>
<h2 id="Promiseæ˜¯ä»€ä¹ˆ"><a href="#Promiseæ˜¯ä»€ä¹ˆ" class="headerlink" title="Promiseæ˜¯ä»€ä¹ˆ"></a>Promiseæ˜¯ä»€ä¹ˆ</h2><p><strong><code>Promise</code>è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆç»“æœ</strong>ã€‚è¿™ä¸å¤ªå®¹æ˜“ç†è§£ï¼Œå¯ä»¥å°†<code>Promise</code>ç†è§£ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œå®ƒå­˜åœ¨ä¸‹é¢ä¸‰ç§ä¸åŒçš„çŠ¶æ€ï¼Œå¹¶åœ¨æŸä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ç§çŠ¶æ€</p>
<ul>
<li>Pendingï¼šè¡¨ç¤ºè¿˜åœ¨æ‰§è¡Œ</li>
<li>Fulfilledæˆ–è€…Resolvedï¼šæ‰§è¡ŒæˆåŠŸ</li>
<li>Rejectedï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>
<p>ä¸€ä¸ªPromiseæ˜¯å¯¹ä¸€ä¸ªæ“ä½œï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„å°è£…ï¼Œå¼‚æ­¥æ“ä½œæœ‰ç­‰å¾…å®Œæˆã€æˆåŠŸã€å¤±è´¥ä¸‰ç§å¯èƒ½ç»“æœï¼Œå¯¹åº”äº†Promiseçš„ä¸‰ç§çŠ¶æ€</p>
<p><strong>Promiseçš„çŠ¶æ€åªèƒ½ç”±<code>Pendingè½¬æ¢ä¸ºResolved</code>æˆ–è€…ç”±<code>Pendingè½¬æ¢ä¸ºRejected</code>ï¼Œä¸€æ—¦çŠ¶æ€è½¬æ¢å®Œæˆå°±æ— æ³•å†æ”¹å˜</strong></p>
<p>å‡è®¾ç”¨Promiseå°è£…ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œé‚£ä¹ˆå½“å®ƒè¢«åˆ›å»ºçš„æ—¶å€™å°±å¤„äºPendingçŠ¶æ€ï¼Œå½“å¼‚æ­¥æ“ä½œæˆåŠŸå®Œæˆæ—¶ï¼Œå°†çŠ¶æ€è½¬æ¢ä¸ºFulfilledï¼›å¦‚æœæ‰§è¡Œä¸­å‡ºç°é”™è¯¯ï¼Œå°†çŠ¶æ€è½¬æ¢ä¸ºRejected</p>
<h2 id="ES2015ä¸­çš„Promise"><a href="#ES2015ä¸­çš„Promise" class="headerlink" title="ES2015ä¸­çš„Promise"></a>ES2015ä¸­çš„Promise</h2><p><strong><code>Promise</code>å’Œ<code>Class</code>å ªç§°ES2015çš„ä¸¤ä¸ªæœ€é‡è¦çš„ç‰¹æ€§</strong>ï¼Œåœ¨å¦‚ä½•ç»„ç»‡å¼‚æ­¥ä»£ç è¿™ä¸ªé—®é¢˜ä¸Šï¼ŒES2015ä¸­çš„Generatoræˆ–è€…ES2017çš„asyncæ–¹æ³•ï¼Œéƒ½æ˜¯ä»¥Promiseä½œä¸ºåŸºç¡€çš„</p>
<h3 id="å°†å¼‚æ­¥æ–¹æ³•å°è£…æˆPromise"><a href="#å°†å¼‚æ­¥æ–¹æ³•å°è£…æˆPromise" class="headerlink" title="å°†å¼‚æ­¥æ–¹æ³•å°è£…æˆPromise"></a>å°†å¼‚æ­¥æ–¹æ³•å°è£…æˆPromise</h3><p>å¯ä»¥ç”¨Promiseçš„æ„é€ å‡½æ•°æ¥å°è£…ä¸€ä¸ªç°æœ‰çš„å¼‚æ­¥æ“ä½œ</p>
<p><strong>ğŸ‘‡Promiseçš„æ„é€ å‡½æ•°</strong></p>
<pre><code class="javascript">var promise = new Promise(function (resolve, reject) {
    // some code

    if (/*å¼‚æ­¥æ“ä½œæˆåŠŸ*/) {
        resolve(value)
    } else {
        reject(error)
    }
})</code></pre>
<p><strong>ä½¿ç”¨Promiseå°è£…çš„readFile</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function readFile_promise(path) {
    return new Promise(function (resolve, reject) {
        fs.readFile(path, &#39;utf-8&#39;, function (error, data) {
            if (data) {
                resolve(data)
            } else {
                reject(error)
            }
        })
    })
}</code></pre>
<p>å°†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•å°è£…æˆPromiseå…¶å®å¾ˆç®€å•ï¼Œåªè¦åœ¨å›è°ƒå‡½æ•°ä¸­é’ˆå¯¹ä¸åŒçš„è¿”å›ç»“æœè°ƒç”¨resolveæˆ–è€…rejectæ–¹æ³•å³å¯</p>
<ul>
<li>resolveå‡½æ•°ä¼šåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸå®Œæˆæ—¶è¢«è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼ä½œä¸ºå‚æ•°ä¼ é€’åˆ°å¤–éƒ¨</li>
<li>rejectåˆ™æ˜¯åœ¨å¼‚æ­¥æ“ä½œå‡ºç°å¼‚å¸¸æ—¶è¢«è°ƒç”¨ï¼Œä¼šå°†é”™è¯¯ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»</li>
</ul>
<p>åˆšåˆšæ¥è§¦Promiseæ¦‚å¿µçš„å¼€å‘è€…å¯èƒ½ä¼šå¯¹è¿™ä¸¤ä¸ªæ–¹æ³•æ„Ÿåˆ°å›°æƒ‘ï¼Œç®€å•åœ°è¯´ï¼Œä¸€ä¸ªå°è£…äº†å¼‚æ­¥æ“ä½œçš„Promiseå¯¹è±¡å®é™…ä¸Šå¹¶æ²¡æœ‰åšä»»ä½•äº‹æƒ…ï¼Œå®ƒä»…ä»…é’ˆå¯¹å›è°ƒå‡½æ•°çš„ä¸åŒç»“æœå®šä¹‰äº†ä¸åŒçš„çŠ¶æ€</p>
<p>resolveæ–¹æ³•å’Œrejectæ–¹æ³•æ²¡æœ‰åšå¤šä½™çš„æ“ä½œï¼Œä»…ä»…æ˜¯æŠŠå¼‚æ­¥çš„ç»“æœä¼ é€’å‡ºå»ï¼Œ<strong>å¯¹äºå¼‚æ­¥ç»“æœçš„å¤„ç†ï¼Œæ˜¯äº¤ç»™<code>then</code>æ–¹æ³•æ¥å®Œæˆçš„</strong></p>
<h3 id="ä½¿ç”¨thenæ–¹æ³•è·å–ç»“æœ"><a href="#ä½¿ç”¨thenæ–¹æ³•è·å–ç»“æœ" class="headerlink" title="ä½¿ç”¨thenæ–¹æ³•è·å–ç»“æœ"></a>ä½¿ç”¨thenæ–¹æ³•è·å–ç»“æœ</h3><p>åœ¨å°è£…å¥½Promiseå¯¹è±¡åï¼Œå°±å¯ä»¥è°ƒç”¨<code>then</code>æ–¹æ³•æ¥è·å–å¼‚æ­¥æ“ä½œçš„å€¼</p>
<pre><code class="javascript">process.then(function (value) {
    // success
}, function (error) {
    // failure
})</code></pre>
<p><code>then</code>æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªåŒ¿åå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå®ƒä»¬ä»£è¡¨<code>onResolved</code>å’Œ<code>onRejected</code>å‡½æ•°</p>
<p><code>value</code>å’Œ<code>error</code>å‚æ•°ä»£è¡¨å›è°ƒçš„ç»“æœï¼Œä»¥readFileä¸ºä¾‹ï¼Œ<code>value</code>å°±æ˜¯æ‰§è¡ŒæˆåŠŸæ—¶æ–‡æœ¬å†…å®¹ï¼Œ<code>error</code>åˆ™æ˜¯æ‰§è¡Œå‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸¤è€…ä¸­å¿…æœ‰ä¸€ä¸ªä¸ä¸ºç©º</p>
<p><strong>é€šå¸¸å¦‚æœ<code>onRejected</code>çš„å›è°ƒæ–¹æ³•è¢«è°ƒç”¨å°±è¡¨ç¤ºå¼‚æ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œæ˜¯ä½¿ç”¨<code>catch</code>æ–¹æ³•è€Œä¸æ˜¯å›è°ƒå‡½æ•°æ¥å¤„ç†å¼‚å¸¸</strong></p>
<pre><code class="javascript">promise
    .then(function (data) {
        // success
    })
    .catch(function (err) {
        // error
    })</code></pre>
<h3 id="thenæ–¹æ³•çš„è¿”å›å€¼"><a href="#thenæ–¹æ³•çš„è¿”å›å€¼" class="headerlink" title="thenæ–¹æ³•çš„è¿”å›å€¼"></a>thenæ–¹æ³•çš„è¿”å›å€¼</h3><p>thenæ–¹æ³•æ€»æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ï¼Œè¿™ä¹Ÿå°±è¡¨ç¤ºå¯¹äºä¸€ä¸ªPromiseå¯ä»¥å¤šæ¬¡è°ƒç”¨å®ƒçš„thenæ–¹æ³•ï¼Œä½†ç”±äº<strong>é»˜è®¤è¿”å›çš„Promiseæ˜¯ä¸€ä¸ªç©ºçš„å¯¹è±¡</strong>ï¼Œé™¤éåšä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå¦åˆ™è¿™ä¸€æ“ä½œé€šå¸¸å¾—ä¸åˆ°æœ‰æ„ä¹‰çš„å€¼</p>
<pre><code class="javascript">var promise = readFile_promise(&#39;foo.txt&#39;)

promise.then(function (value) {
    console.log(value) // foo
}).then(function (value) { ğŸ‘ˆ æ­¤æ—¶ç›¸å½“äº{}.then() 
    console.log(value) // undefined
})</code></pre>
<p>å¼€å‘è€…ä¹Ÿå¯ä»¥åœ¨å›è°ƒå‡½æ•°å®šä¹‰ä¸€ä¸ªæ–°çš„Promiseï¼Œç„¶åä½¿ç”¨returnæ¥è¿”å›</p>
<pre><code class="javascript">var promise = readFile_promise(&#39;foo.txt&#39;)

promise.then(function (value) {
    console.log(value) // foo
    return readFile_promise(&#39;bar.txt&#39;)
}).then(function (value) {
    console.log(value) // bar
})</code></pre>
<p>ğŸ‘†ç¬¬ä¸€ä¸ª<code>then</code>æ–¹æ³•ä¸­ï¼Œå†æ¬¡è°ƒç”¨<code>readFile_promise</code>ï¼Œå…¶è¿”å›çš„æ–°çš„Promiseè¦†ç›–äº†é»˜è®¤è¿”å›çš„Promiseç©ºå¯¹è±¡ï¼Œæˆ‘ä»¬å› æ­¤å¯ä»¥åœ¨ä¸‹ä¸€ä¸ª<code>then</code>æ–¹æ³•ä¸­è·å–å¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æ‰§è¡Œç»“æœ</p>
<h3 id="Promiseçš„æ‰§è¡Œ"><a href="#Promiseçš„æ‰§è¡Œ" class="headerlink" title="Promiseçš„æ‰§è¡Œ"></a>Promiseçš„æ‰§è¡Œ</h3><p>â“è™½ç„¶æ˜¯é€šè¿‡<code>then</code>æ–¹æ³•æ¥è·å–Promiseçš„ç»“æœï¼Œä½†Promiseæ˜¯ä¸æ˜¯å½“<code>then</code>æ–¹æ³•è°ƒç”¨ä¹‹åæ‰ä¼šæ‰§è¡Œ</p>
<pre><code class="javascript">var promise = new Promise((resolve, reject) =&gt; {
    console.log(&#39;begin&#39;)
    resolve()
})

setTimeout(() =&gt; {
    promise.then(() =&gt; {
        console.log(&#39;end&#39;)
    })
}, 1000)</code></pre>
<p>å®é™…è¿è¡Œå°±ä¼šå‘ç°ï¼Œç¨‹åºç«‹åˆ»æ‰“å°å‡ºbeginï¼Œç„¶åç­‰å¾…1ç§’ï¼Œéšåå†æ‰“å°å‡ºend</p>
<p><strong>Promiseä»è¢«åˆ›å»ºçš„é‚£ä¸€åˆ»èµ·å°±å¼€å§‹æ‰§è¡Œï¼Œthenæ–¹æ³•åªæ˜¯æä¾›äº†è®¿é—®PromiseçŠ¶æ€çš„æ¥å£ï¼Œä¸Promiseçš„æ‰§è¡Œæ— å…³</strong></p>
<h2 id="Promiseçš„å¸¸ç”¨API"><a href="#Promiseçš„å¸¸ç”¨API" class="headerlink" title="Promiseçš„å¸¸ç”¨API"></a>Promiseçš„å¸¸ç”¨API</h2><h3 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve"></a>Promise.resolve</h3><p>Promiseæä¾›<code>resolve</code>æ–¹æ³•ç”¨æ¥å°†éPromiseå¯¹è±¡è½¬åŒ–ä¸ºPromiseå¯¹è±¡</p>
<p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸»åŠ¨è°ƒç”¨<code>resolve</code>æ–¹æ³•çš„åœºæ™¯å¹¶ä¸å¤šï¼Œå› ä¸ºè¯¥æ–¹æ³•èƒ½è½¬æ¢çš„é€šå¸¸åªæœ‰<code>thenable</code>å¯¹è±¡å’Œä¸€äº›åŸå§‹ç±»å‹çš„å¯¹è±¡</p>
<p><strong><code>thenable</code>å¯¹è±¡æ˜¯æŒ‡æœ‰<code>then</code>æ–¹æ³•çš„å¯¹è±¡ï¼Œä¸€ä¸ªå¸¸è§çš„ä¾‹å­å°±æ˜¯jQueryä¸­çš„<code>deferred</code>å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„å¯¹è±¡</strong></p>
<p>å…¶è¢«è½¬æ¢æˆPromiseåï¼Œè½¬æ¢åçš„Promiseä¼šè‡ªåŠ¨æ‰§è¡Œå…¶<code>then</code>æ–¹æ³•</p>
<pre><code class="javascript">var obj = {
    then: () =&gt; {
        console.log(&#39;I am a then method&#39;)
    }
}

Promise.resolve(obj) // I am a then method</code></pre>
<p>å¦‚æœè½¬æ¢çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¸¸é‡æˆ–è€…ä¸å…·å¤‡çŠ¶æ€çš„è¯­å¥ï¼Œè½¬æ¢åçš„å¯¹è±¡è‡ªåŠ¨å¤„äº<code>resolve</code>çŠ¶æ€ï¼Œè½¬æ¢çš„å¯¹è±¡ä½œä¸º<code>resolved</code>çš„ç»“æœåŸå°ä¸åŠ¨åœ°ä¿ç•™</p>
<pre><code class="javascript">var p = Promise.resolve(&#39;0xGeekCat&#39;)

p.then(function (result) {
    console.log(result) // 0xGeekCat
})</code></pre>
<p><code>resolve</code>å¹¶ä¸èƒ½ç”¨æ¥è½¬æ¢ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•</p>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%203.png" alt="screenshot 3"></p>
<p>è¦è½¬æ¢å¼‚æ­¥æ–¹æ³•ï¼Œè¦ä¹ˆæ‰‹åŠ¨å°è£…ä¸€ä¸ªPromiseï¼Œè¦ä¹ˆå°±ä½¿ç”¨ä¸€äº›ç°æˆçš„æ–¹æ³•æˆ–è€…æ¨¡å—æ¥æ“ä½œ</p>
<h3 id="promise-reject"><a href="#promise-reject" class="headerlink" title="promise.reject"></a>promise.reject</h3><p><code>promise.reject</code>åŒæ ·è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¿™ä¸ªPromiseçš„çŠ¶æ€ä¸º<code>reject</code>ï¼Œ<code>reject</code>æ–¹æ³•çš„å‚æ•°ä¼šä½œä¸ºé”™è¯¯ä¿¡æ¯ä¼ é€’ç»™<code>then</code>æ–¹æ³•</p>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%204.png" alt="screenshot 4"></p>
<p>çœ‹åˆ°æ§åˆ¶å°çš„warningä¿¡æ¯ï¼Œè¡¨æ˜<code>reject</code>çŠ¶æ€çš„Promiseæœ‰å¯èƒ½ç­‰åŒäº<code>error</code>è€Œä½¿è¿›ç¨‹é€€å‡º</p>
<p>åœ¨ä½¿ç”¨Promiseæ—¶æœ€å¥½åŠ ä¸Š<code>catch</code>æ¥æ•è·è¿™ä¸ªå¼‚å¸¸</p>
<pre><code class="javascript">var promise = readFile_promise(&#39;foo.txt&#39;)

promise.then(function (value) {
    console.log(value)
}).catch(function (err) {
    console.log(&#39;error occurred&#39;, err)
})</code></pre>
<h3 id="promise-all"><a href="#promise-all" class="headerlink" title="promise.all"></a>promise.all</h3><p>å¦‚æœæœ‰å¤šä¸ªPromiseéœ€è¦æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨<code>promise.all</code>æ–¹æ³•ç»Ÿä¸€å£°æ˜ï¼Œ<strong>è¯¥æ–¹æ³•å°†å¤šä¸ªPromiseå¯¹è±¡åŒ…è£…æˆä¸€ä¸ªPromise</strong></p>
<p>è¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œæ•°æ®çš„å…ƒç´ å¦‚æœä¸æ˜¯Promiseå¯¹è±¡ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨resolveæ–¹æ³•è½¬æ¢</p>
<p>åªæœ‰æ•°ç»„ä¸­çš„Promiseçš„çŠ¶æ€å…¨éƒ¨å˜æˆ<code>resolved</code>ä¹‹åï¼Œ<code>all</code>æ–¹æ³•ç”ŸæˆPromiseçš„çŠ¶æ€æ‰ä¼šå˜æˆ<code>resolved</code>ï¼›å¦‚æœä¸­é—´æœ‰ä¸€ä¸ªPromiseçŠ¶æ€ä¸º<code>reject</code>ï¼Œé‚£ä¹ˆè½¬æ¢åçš„Promiseä¹Ÿä¼šå˜æˆ<code>reject</code>ï¼Œå¹¶ä¸”å°†é”™è¯¯ä¿¡æ¯ä¼ ç»™<code>catch</code>æ–¹æ³•</p>
<pre><code class="javascript">var promises = [&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;].map(function (path) {
    return readFile_promise(path)
})

Promise.all(promises).then(function (results) {
    console.log(results) // [ &#39;foo&#39;, &#39;bar&#39;, &#39;baz&#39; ]
}).catch(function (err) {
    console.log(&#39;error occurred&#39;, err)
})</code></pre>
<p>ä½¿ç”¨<code>promise.all</code>æ–¹æ³•å°è£…çš„Promiseï¼Œå¦‚æœå°†ç»“æœé›†æ‰“å°å‡ºæ¥ï¼Œä¼šå‘ç°å®ƒä»¬æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„</p>
<p><strong>â“æ—¢ç„¶<code>promise.all</code>ä¼šæŒ‰ç…§é¡ºåºè¿”å›å°è£…Promiseçš„ç»“æœï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä»£è¡¨å†…éƒ¨çš„Promiseæ˜¯é¡ºåºæ‰§è¡Œçš„</strong></p>
<p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå‰é¢å·²ç»æåˆ°ä¸€ä¸ªPromiseçš„æ‰§è¡Œæ˜¯ä»è¢«åˆ›å»ºçš„é‚£ä¸€åˆ»å¼€å§‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“è°ƒç”¨<code>promise.all</code>æ—¶ï¼Œæ‰€æœ‰çš„Promiseéƒ½å·²ç»å¼€å§‹æ‰§è¡Œäº†ï¼Œ**<code>all</code>æ–¹æ³•åªæ˜¯ç­‰åˆ°å…¨éƒ¨çš„Promiseå®Œæˆåï¼Œå¯¹æ‰€æœ‰çš„æ‰§è¡Œç»“æœåšåŒ…è£…å†è¿”å›**</p>
<h3 id="promise-race"><a href="#promise-race" class="headerlink" title="promise.race"></a>promise.race</h3><p><code>race</code>æ–¹æ³•æ¥æ”¶Promiseæ•°ç»„ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„Promiseï¼Œæ•°ç»„ä¸­çš„Promiseä¼šåŒæ—¶å¼€å§‹æ‰§è¡Œï¼Œ<code>race</code>è¿”å›çš„Promiseçš„çŠ¶æ€ç”±æ•°ç»„ä¸­ç‡å…ˆæ‰§è¡Œå®Œæ¯•çš„Promiseçš„çŠ¶æ€å†³å®š</p>
<pre><code class="javascript">function timeout(ms) {
    return new Promise((resolve, reject) =&gt; {
        setTimeout(resolve, ms, &#39;timeout first&#39;)
    })
}

let promise = Promise.race([timeout(1), readFile_promise(&#39;foo.txt&#39;)])

promise.then(function (value) {
    console.log(value)
})</code></pre>
<p>ğŸ‘†ä¸¤ä¸ªPromiseï¼Œå¦‚æœ<code>readFile_promise</code>å…ˆå®Œæˆï¼Œthenæ–¹æ³•æ‰“å°å‡ºçš„å°±æ˜¯æ–‡ä»¶å†…å®¹ã€‚ç”±äº<code>timeout</code>åªè®¾ç½®äº†1msï¼Œé€šå¸¸å°äºè¯»å–æ–‡ä»¶éœ€è¦çš„æ—¶é—´ï¼Œå› æ­¤è°ƒç”¨<code>then</code>æ–¹æ³•æ€»æ˜¯ä¼šæ‰“å°å‡º<code>timeout first</code></p>
<p>çœ‹èµ·æ¥<code>race</code>æ–¹æ³•ä¼¼ä¹æ²¡ç‰¹åˆ«çš„ç”¨å¤„ï¼Œä½†åœ¨å¤„ç†WebæœåŠ¡å™¨ä¸­çš„è¶…æ—¶é€»è¾‘æ—¶ååˆ†æ–¹ä¾¿ï¼Œä¾‹å¦‚ä¸ºä¸€ä¸ªPromiseï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œå®šä¹‰äº†100msçš„æ‰§è¡Œæ—¶é™ï¼Œå¦‚æœè€—æ—¶è¶…è¿‡è¿™ä¸ªæ—¶é—´å°±è¿”å›ä¸€ä¸ªè¶…æ—¶é”™è¯¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨raceæ–¹æ³•</p>
<h3 id="promise-catch"><a href="#promise-catch" class="headerlink" title="promise.catch"></a>promise.catch</h3><p>Promiseåœ¨æ‰§è¡Œä¸­å¦‚æœå‡ºäº†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨<code>throw</code>å…³é”®å­—æŠ›å‡ºé”™è¯¯ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨<code>catch</code>æ–¹æ³•è¿›è¡Œæ•è·ï¼›å¦‚æœä¸è®¾ç½®ä»»ä½•å›è°ƒå‡½æ•°æ•æ‰é”™è¯¯ï¼ŒPromiseå†…éƒ¨æŠ›å‡ºçš„é”™è¯¯å°±æ— æ³•ä¼ é€’åˆ°å¤–éƒ¨</p>
<pre><code class="javascript">var promise = new Promise(function (resolve, reject) {
    throw new Error(&#39;get error&#39;)
})

promise.catch(function (err) {
    console.log(err)
})</code></pre>
<p>é™¤äº†ä½¿ç”¨<code>throw</code>ä¸»åŠ¨æŠ›å‡ºé”™è¯¯ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>reject</code>æ–¹æ³•</p>
<pre><code class="javascript">var promise = new Promise(function (resolve, reject) {
    reject(Error(&#39;get error&#39;))
})

promise.catch(function (err) {
    console.log(err)
})</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%205.png" alt="screenshot 5"></p>
<p>å¦‚æœPromiseçš„çŠ¶æ€å·²ç»å˜æˆresolvedï¼Œé‚£ä¹ˆæ­¤æ—¶å†æŠ›å‡ºé”™è¯¯æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºè¿™ç›¸å½“äºæ”¹å˜ä¸€ä¸ªçŠ¶æ€ç¡®å®šçš„Promiseçš„çŠ¶æ€ï¼ŒğŸ‘†æåˆ°è¿‡Promiseä¸€æ—¦çŠ¶æ€è½¬æ¢å®Œæˆå°±æ— æ³•å†æ”¹å˜</p>
<pre><code class="javascript">var promise = new Promise(function (resolve, reject) {
    reject(&#39;0xGeekCat&#39;)
    throw new Error(&#39;get error&#39;)
})

promise.catch(function (err) {
    console.log(err) // 0xGeekCat
})</code></pre>
<h2 id="ä½¿ç”¨Promiseç»„ç»‡å¼‚æ­¥ä»£ç "><a href="#ä½¿ç”¨Promiseç»„ç»‡å¼‚æ­¥ä»£ç " class="headerlink" title="ä½¿ç”¨Promiseç»„ç»‡å¼‚æ­¥ä»£ç "></a>ä½¿ç”¨Promiseç»„ç»‡å¼‚æ­¥ä»£ç </h2><p><strong>ğŸ””ä½¿ç”¨promiseçš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å¤šä¸ªå¼‚æ­¥æ“ä½œé¡ºåºæ‰§è¡Œçš„é—®é¢˜</strong>ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨<code>then</code>çš„é“¾å¼è°ƒç”¨æ¥å®ç°è¿™ä¸€ç›®æ ‡</p>
<p><strong>ä½¿ç”¨Promiseçš„é“¾å¼è°ƒç”¨æ”¹å†™ä¸‰ä¸ªæ–‡æœ¬æ–‡ä»¶é¡ºåºè¯»å–</strong></p>
<pre><code class="javascript">readFile_promise(&#39;foo.txt&#39;).then(function (value) {
    console.log(value)
    return readFile_promise(&#39;bar.txt&#39;)
}).then(function (value) {
    console.log(value)
    return readFile_promise(&#39;baz.txt&#39;)
}).then(function (value) {
    console.log(value)
})</code></pre>
<p>ğŸ‘†ä¸€å †<strong>é“¾å¼è°ƒç”¨</strong>è®©äººå¤´æ™•ï¼Œè¿™ä¹Ÿæ˜¯Promiseçš„ä¸è¶³ä¹‹å¤„ï¼›ä¸ºäº†å†æ¬¡ç®€åŒ–ï¼Œå¯ä»¥è€ƒè™‘åˆ©ç”¨CPSå°†thenæ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°æŠ½å‡ºæ¥</p>
<pre><code class="javascript">var list = [&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;]
var count = 0
readFile_promise(&#39;foo.txt&#39;).then(readCB).then(readCB).then(readCB)

function readCB(data) {
    console.log(data)

    if (++ count &gt; 2)
        return
    return readFile_promise(list[count]);
}</code></pre>
<h2 id="ç¬¬ä¸‰æ–¹æ¨¡å—çš„Promise"><a href="#ç¬¬ä¸‰æ–¹æ¨¡å—çš„Promise" class="headerlink" title="ç¬¬ä¸‰æ–¹æ¨¡å—çš„Promise"></a>ç¬¬ä¸‰æ–¹æ¨¡å—çš„Promise</h2><p>åœ¨Nodeå®Œå…¨æ”¯æŒPromiseä¹‹å‰ï¼Œå¼€å‘è€…ä»¬é€šå¸¸æ˜¯ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“æä¾›çš„åŠŸèƒ½æ¥ä½¿ç”¨Promise</p>
<p><strong><code>bluebird</code>æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„Promiseç¬¬ä¸‰æ–¹åº“</strong>ï¼Œé¡¹ç›®å¼€å§‹äº2013å¹´ï¼Œå®ƒæä¾›äº†å®Œæ•´çš„Promiseé€»è¾‘ä»¥åŠå¯¹éPromiseæ–¹æ³•è½¬æ¢ä¸ºPromiseçš„æ”¯æŒï¼Œè€Œä¸”åœ¨æ‰§è¡Œæ•ˆç‡ä¸Šé«˜äºåŸç”Ÿçš„Promise</p>
<h3 id="æ–°å»ºPromise"><a href="#æ–°å»ºPromise" class="headerlink" title="æ–°å»ºPromise"></a>æ–°å»ºPromise</h3><p><strong>ä½¿ç”¨bluebirdå°è£…Ajaxæ–¹æ³•</strong></p>
<pre><code class="javascript">var Promise = require(&#39;bluebird&#39;)

function ajaxGetAsync(url) {
    return new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest
        xhr.addEventListener(&#39;error&#39;, reject)
        xhr.addEventListener(&#39;load&#39;, resolve)
        xhr.open(&#39;GET&#39;, url)
        xhr.send(null)
    })
}</code></pre>
<p>å’ŒåŸç”Ÿçš„Promiseæ„é€ å‡½æ•°æ²¡æœ‰å¤ªå¤§åŒºåˆ«</p>
<h3 id="ä½¿ç”¨Promisifyæ¥è½¬æ¢å¼‚æ­¥æ–¹æ³•"><a href="#ä½¿ç”¨Promisifyæ¥è½¬æ¢å¼‚æ­¥æ–¹æ³•" class="headerlink" title="ä½¿ç”¨Promisifyæ¥è½¬æ¢å¼‚æ­¥æ–¹æ³•"></a>ä½¿ç”¨Promisifyæ¥è½¬æ¢å¼‚æ­¥æ–¹æ³•</h3><p><strong>è¦ä½¿ç”¨Promiseï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªPromiseï¼Œè¦ä¹ˆæŠŠç°æœ‰çš„æ–¹æ³•è½¬æ¢ä¸ºPromise</strong></p>
<p>bluebirdæä¾›<code>promisify</code>æ–¹æ³•ï¼Œç”¨æ¥ç›´æ¥å°†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•è½¬æ¢ä¸ºPromiseï¼Œè¿™ä¼°è®¡æ˜¯bluebirdæœ€å¸¸ç”¨çš„APIï¼Œæ—¶è‡³ä»Šæ—¥ï¼Œè¯¥æ–¹æ³•çš„æ„ä¹‰å·²ç»æ²¡é‚£ä¹ˆå¤§äº†ï¼Œä½†å§‘ä¸”åœ¨è¿™é‡Œæ ‡è®°ä¸€ä¸‹</p>
<p><strong>ä½¿ç”¨Promisifyå°†ä¸€ä¸ªæ–¹æ³•è½¬æ¢ä¸ºPromise</strong></p>
<pre><code class="javascript">var {promisify} = require(&#39;bluebird&#39;)
var readFile_promise = promisify(require(&#39;fs&#39;).readFile)

readFile_promise(&#39;foo.txt&#39;, &#39;utf8&#39;).then(function (result) {
    console.log(result)
}).catch(function (err) {
    console.log(&#39;error:&#39;, err)
})</code></pre>
<p><code>bluebird</code>è¿˜æä¾›<code>promisifyAll</code>æ–¹æ³•æ¥è½¬æ¢ä¸€ä¸ªå¯¹è±¡çš„å…¨éƒ¨æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä¾¿åˆ©æ€§è¶…ä¹æƒ³è±¡ã€‚æ¯”å¦‚å¯ä»¥å°†<code>fs</code>æ¨¡å—çš„å…¨éƒ¨æ–¹æ³•æ‰¹é‡è½¬æ¢æˆPromiseå½¢å¼ï¼Œçœå»ä¸€ä¸ªä¸ªåœ°è¿›è¡Œè½¬æ¢</p>
<pre><code class="javascript">var {promisifyAll} = require(&#39;bluebird&#39;)
var fs = promisifyAll(require(&#39;fs&#39;))

fs.readFileAsync(&#39;read.js&#39;, &#39;utf8&#39;).then(function (result) {
    console.log(result)
}).catch(function (err) {
    console.log(err.stack)
})</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%206.png" alt="screenshot 6"></p>
<p><code>promisifyAll</code>é€šå¸¸ç”¨äºè½¬æ¢ä¸€ä¸ªå¯¹è±¡çš„å…¨éƒ¨æ–¹æ³•ï¼Œæ¯”å¦‚ğŸ‘†ä¼šè½¬æ¢æ•´ä¸ª<code>fs</code>æ¨¡å—å†…éƒ¨çš„å¼‚æ­¥æ–¹æ³•ï¼Œ<code>bluebird</code>ä¼šåœ¨åŸæ–¹æ³•åä¹‹ååŠ ä¸Š<code>Async</code>åç¼€ï¼Œä¾‹å¦‚<code>readFile</code>çš„PromiseåŒ–åçš„æ–¹æ³•åä¸º<code>readFileAsync</code></p>
<h1 id="Generatorï¼Œä¸€ç§è¿‡æ¸¡æ–¹æ¡ˆ"><a href="#Generatorï¼Œä¸€ç§è¿‡æ¸¡æ–¹æ¡ˆ" class="headerlink" title="Generatorï¼Œä¸€ç§è¿‡æ¸¡æ–¹æ¡ˆ"></a>Generatorï¼Œä¸€ç§è¿‡æ¸¡æ–¹æ¡ˆ</h1><p>æ— è®ºæ˜¯æ¦‚å¿µè¿˜æ˜¯å½¢å¼ä¸Šï¼ŒES2015ä¸­çš„Generatorå‡ ä¹å°±æ˜¯Pythonä¸­Generatorçš„ç¿»ç‰ˆ</p>
<p><strong>ğŸ””Generatoræœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥è¢«ä¸­æ–­ï¼Œç„¶åæ¢å¤æ‰§è¡Œ</strong></p>
<p>é€šå¸¸æ¥è¯´ï¼Œå½“å¼€å‘è€…è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¹‹åï¼Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œå°±è„±ç¦»äº†å¼€å‘è€…çš„æ§åˆ¶ï¼Œåªæœ‰å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ§åˆ¶æƒæ‰èƒ½é‡æ–°å›åˆ°è°ƒç”¨è€…æ‰‹ä¸­ï¼Œå› æ­¤ç¨‹åºå‘˜åœ¨ç¼–å†™æ–¹æ³•ä»£ç æ—¶ï¼Œå”¯ä¸€èƒ½å¤Ÿå½±å“æ–¹æ³•æ‰§è¡Œçš„åªæœ‰é¢„å…ˆå®šä¹‰çš„<code>return</code>å…³é”®å­—</p>
<p>Promiseä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ–°å»ºä¸€ä¸ªPromiseåï¼Œå…¶çŠ¶æ€è‡ªåŠ¨è½¬æ¢ä¸ºpendingåŒæ—¶å¼€å§‹æ‰§è¡Œï¼Œç›´åˆ°çŠ¶æ€æ”¹å˜åæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</p>
<p>è€ŒGeneratorå‡½æ•°ä¸åŒï¼ŒGeneratorå‡½æ•°å¯ä»¥ç”±ç”¨æˆ·æ‰§è¡Œä¸­æ–­æˆ–è€…æ¢å¤æ‰§è¡Œçš„æ“ä½œï¼ŒGeneratorä¸­æ–­åå¯ä»¥è½¬å»æ‰§è¡Œåˆ«çš„æ“ä½œï¼Œç„¶åå†å›è¿‡å¤´ä»ä¸­æ–­çš„åœ°æ–¹æ¢å¤æ‰§è¡Œï¼Œ<strong>è¿™å…¶å®æ˜¯ä¸€ç§åç¨‹çš„æ¦‚å¿µ</strong></p>
<h2 id="Generatorçš„ä½¿ç”¨"><a href="#Generatorçš„ä½¿ç”¨" class="headerlink" title="Generatorçš„ä½¿ç”¨"></a>Generatorçš„ä½¿ç”¨</h2><p>Generatorå‡½æ•°å’Œæ™®é€šå‡½æ•°åœ¨å¤–è¡¨ä¸Šä¸¤ä¸ªæœ€å¤§çš„åŒºåˆ«</p>
<ul>
<li>åœ¨functionå…³é”®å­—å’Œæ–¹æ³•åä¸­é—´æœ‰ä¸ªæ˜Ÿå·</li>
<li>æ–¹æ³•ä½“ä¸­ä½¿ç”¨<code>yield</code>å…³é”®å­—</li>
</ul>
<pre><code class="javascript">function* Generator() {
    yield &#39;0xGeekCat&#39;
    return &#39;end&#39;
}</code></pre>
<p>å’Œæ™®é€šæ–¹æ³•ä¸€æ ·ï¼ŒGeneratorå¯ä»¥å®šä¹‰æˆå¤šç§å½¢å¼</p>
<pre><code class="javascript">// æ™®é€šæ–¹æ³•
function* generator() {}

// å‡½æ•°è¡¨è¾¾å¼
var gen = function* generator() {}

// å¯¹è±¡å±æ€§æ–¹æ³•
var obj = {
    * generator() {}
}</code></pre>
<p><strong>Generatorå‡½æ•°çš„çŠ¶æ€</strong></p>
<p><code>yield</code>å…³é”®å­—ç”¨æ¥å®šä¹‰å‡½æ•°æ‰§è¡Œçš„çŠ¶æ€ï¼Œå¦‚æœGeneratorä¸­å®šä¹‰äº†<code>x</code>ä¸ª<code>yield</code>å…³é”®å­—ï¼Œé‚£ä¹ˆå°±æœ‰<code>x + 1</code>ç§çŠ¶æ€ï¼Œå› ä¸ºæœ€åçš„returnè¯­å¥</p>
<h2 id="Generatorå‡½æ•°çš„æ‰§è¡Œ"><a href="#Generatorå‡½æ•°çš„æ‰§è¡Œ" class="headerlink" title="Generatorå‡½æ•°çš„æ‰§è¡Œ"></a>Generatorå‡½æ•°çš„æ‰§è¡Œ</h2><p>è·Ÿæ™®é€šå‡½æ•°ç›¸æ¯”ï¼ŒGeneratorå‡½æ•°æ›´åƒæ˜¯ä¸€ä¸ªç±»æˆ–è€…ä¸€ç§æ•°æ®ç±»å‹</p>
<p>ç›´æ¥æ‰§è¡ŒGeneratorä¼šå¾—åˆ°Generatorå¯¹è±¡ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ–¹æ³•ä½“ä¸­çš„å†…å®¹</p>
<pre><code class="javascript">function* Generator() {
    yield &#39;0xGeekCat&#39;
    return &#39;end&#39;
}

var gen = Generator()
console.log(gen) // Object [Generator] {}</code></pre>
<p>æŒ‰ç…§é€šå¸¸çš„æ€è·¯ï¼Œ<code>gen</code>åº”è¯¥æ˜¯<code>Generator()</code>å‡½æ•°çš„è¿”å›å€¼ï¼ŒğŸ‘†ä¹Ÿæåˆ°Generatorå‡½æ•°å¯èƒ½æœ‰å¤šç§çŠ¶æ€ï¼ŒPromiseä¹Ÿå¯èƒ½æœ‰ä¸‰ç§çŠ¶æ€ã€‚ä¸åŒçš„æ˜¯Promiseåªèƒ½æœ‰ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œè€ŒGeneratorå¯¹è±¡ä¼šé€ä¸ªç»å†æ‰€æœ‰çš„çŠ¶æ€ï¼Œç›´åˆ°Generatorå‡½æ•°æ‰§è¡Œå®Œæ¯•</p>
<p><strong>å½“è°ƒç”¨Generatorå‡½æ•°ä¹‹åï¼Œè¯¥å‡½æ•°å¹¶æ²¡æœ‰ç«‹åˆ»æ‰§è¡Œï¼Œå‡½æ•°çš„è¿”å›ç»“æœä¹Ÿä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥å°†è¯¥å¯¹è±¡ç†è§£ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘Generatorå‡½æ•°å½“å‰çš„çŠ¶æ€</strong></p>
<p>å½“Generatorè¢«è°ƒç”¨åï¼ŒæŒ‡é’ˆæŒ‡å‘æ–¹æ³•ä½“çš„å¼€å§‹è¡Œï¼Œå½“nextæ–¹æ³•è°ƒç”¨åï¼Œè¯¥æŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ï¼Œæ–¹æ³•ä¹Ÿè·Ÿç€å‘ä¸‹æ‰§è¡Œï¼Œæœ€åä¼šåœåœ¨ç¬¬ä¸€ä¸ªé‡åˆ°çš„yieldå…³é”®å­—å‰é¢ï¼Œå½“å†æ¬¡è°ƒç”¨nextæ–¹æ³•æ—¶ï¼ŒæŒ‡é’ˆä¼šç»§ç»­ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªyieldå…³é”®å­—ï¼Œç›´åˆ°è¿è¡Œåˆ°æ–¹æ³•çš„æœ€åä¸€è¡Œ</p>
<pre><code class="javascript">var gen = Generator()
console.log(gen.next())
console.log(gen.next())
console.log(gen.next())</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%207.png" alt="screenshot 7"></p>
<p>ä¸Šé¢çš„ä»£ç ä¸€å…±è°ƒç”¨äº†ä¸‰æ¬¡<code>next</code>æ–¹æ³•ï¼Œæ¯æ¬¡éƒ½è¿”å›ä¸€ä¸ªåŒ…å«æ‰§è¡Œä¿¡æ¯çš„å¯¹è±¡</p>
<ul>
<li>ä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼</li>
<li>ä¸€ä¸ªæ ‡è®°æ‰§è¡ŒçŠ¶æ€çš„flag</li>
</ul>
<p><strong>åˆ†æ3æ¬¡nextè§¦å‘çš„ç¨‹åºè¿è¡Œ</strong></p>
<ol>
<li>é‡åˆ°ä¸€ä¸ªyieldè¯­å¥ååœæ­¢ï¼Œè¿”å›å¯¹è±¡çš„valueçš„å€¼å°±æ˜¯yieldè¯­å¥çš„å€¼ï¼Œdoneå±æ€§ç”¨æ¥æ ‡å¿—Generatoræ–¹æ³•æ˜¯å¦æ‰§è¡Œå®Œæ¯•</li>
<li>ç¨‹åºæ‰§è¡Œåˆ°returnè¯­å¥çš„ä½ç½®ï¼Œè¿”å›å¯¹è±¡çš„valueå€¼å³ä¸ºreturnè¯­å¥çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰returnè¯­å¥ï¼Œåˆ™ä¼šä¸€ç›´æ‰§è¡Œåˆ°å‡½æ•°ç»“æŸï¼Œvalueå€¼ä¸ºundefinedï¼Œdoneå±æ€§å€¼ä¸ºtrue</li>
<li>Generatorå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤valueçš„å€¼ä¸ºundefined</li>
</ol>
<h3 id="yieldå…³é”®å­—"><a href="#yieldå…³é”®å­—" class="headerlink" title="yieldå…³é”®å­—"></a>yieldå…³é”®å­—</h3><p><code>yield</code>æœ¬æ„ä¸º<strong>ç”Ÿäº§</strong>ï¼Œåœ¨Pythonã€Javaä»¥åŠC#ä¸­éƒ½æœ‰yieldå…³é”®å­—ï¼Œä½†åªæœ‰Pythonä¸­yieldçš„è¯­ä¹‰å’ŒNodeç›¸ä¼¼</p>
<p>å½“nextæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒGeneratorå‡½æ•°å¼€å§‹å‘ä¸‹æ‰§è¡Œï¼Œé‡åˆ°yieldå…³é”®å­—æ—¶ï¼Œä¼šæš‚åœå½“å‰æ“ä½œï¼Œå¹¶ä¸”å¯¹yieldåçš„è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ï¼Œæ— è®ºyieldåé¢è¡¨è¾¾å¼è¿”å›çš„æ˜¯ä½•ç§ç±»å‹çš„å€¼ï¼Œ<strong>yieldæ“ä½œæœ€åè¿”å›çš„éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æœ‰valueå’Œdoneä¸¤ä¸ªå±æ€§</strong></p>
<p>valueå¾ˆå¥½ç†è§£ï¼Œå¦‚æœåé¢æ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹ï¼Œé‚£ä¹ˆvalueçš„å€¼å°±æ˜¯å¯¹åº”çš„å€¼ï¼Œ<strong>æ›´ä¸ºå¸¸è§çš„æ˜¯yieldåé¢è·Ÿçš„æ˜¯Promiseå¯¹è±¡</strong></p>
<p>doneå±æ€§è¡¨ç¤ºå½“å‰Generatorå¯¹è±¡çš„çŠ¶æ€ï¼Œåˆšå¼€å§‹æ‰§è¡Œæ—¶doneå±æ€§çš„å€¼ä¸ºfalseï¼Œå½“Generatoræ‰§è¡Œåˆ°returnè¯­å¥æ—¶ï¼Œdoneçš„å€¼ä¼šå˜æˆtrueï¼Œè¡¨ç¤ºGeneratoræ‰§è¡Œç»“æŸ</p>
<p><strong>â—ï¸yieldå…³é”®å­—æœ¬èº«ä¸äº§ç”Ÿè¿”å›å€¼</strong></p>
<pre><code class="javascript">function* foo(x) {
    var y = yield (x + 1)
    return y
}

var gen = foo(5)
console.log(gen.next())
console.log(gen.next())</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%208.png" alt="screenshot 8"></p>
<p><strong>â“ä¸ºä»€ä¹ˆç¬¬äºŒä¸ª<code>next</code>æ–¹æ³•æ‰§è¡Œåï¼Œ<code>y</code>çš„å€¼å´æ˜¯<code>undefined</code></strong></p>
<p><code>next</code>æ–¹æ³•çš„è¿”å›å€¼æ˜¯<code>yield</code>å…³é”®å­—åé¢è¡¨è¾¾å¼çš„å€¼ï¼Œè€Œ<code>yield</code>å…³é”®å­—æœ¬èº«å¯ä»¥è§†ä¸ºä¸€ä¸ªä¸äº§ç”Ÿè¿”å›å€¼çš„å‡½æ•°ï¼Œå› æ­¤<code>y</code>å¹¶æ²¡æœ‰è¢«èµ‹å€¼</p>
<pre><code class="javascript">function* foo(x) {
    yield y =  (x + 1)
    return &#39;end&#39;
}

var gen = foo(5)
console.log(gen.next())
console.log(gen.next())</code></pre>
<p>ğŸ‘†è¿™æ ·å°±è§£å†³äº†è®¡ç®—<code>y</code>å€¼çš„é—®é¢˜</p>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%209.png" alt="screenshot 9"></p>
<p><code>next</code>æ–¹æ³•è¿˜å¯ä»¥æ¥å—ä¸€ä¸ªæ•°å€¼ä½œä¸ºå‚æ•°ï¼Œä»£è¡¨ä¸Šä¸€ä¸ªyieldæ±‚å€¼çš„ç»“æœ</p>
<pre><code class="javascript">function* foo(x) {
    var y = yield (x + 1)
    return y
}

var gen = foo(5)
console.log(gen.next())
console.log(gen.next(10))</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2010.png" alt="screenshot 10"></p>
<p>ğŸ‘†ä»£ç ç­‰ä»·äº</p>
<pre><code class="javascript">function* foo(x) {
    var y = yield (x + 1)
    y = 10 ğŸ‘ˆ
    return y
}

var gen = foo(5)
console.log(gen.next())
console.log(gen.next())</code></pre>
<p><code>next</code>å¯ä»¥æ¥æ”¶å‚æ•°ä»£è¡¨å¯ä»¥ä»å¤–éƒ¨ä¼ ä¸€ä¸ªå€¼åˆ°Generatorå‡½æ•°å†…éƒ¨ï¼Œ<strong>å®é™…ä¸Šæ­£æ˜¯è¿™ä¸ªç‰¹æ€§ä½¿å¾—Generatorå¯ä»¥ç”¨æ¥ç»„ç»‡å¼‚æ­¥æ–¹æ³•</strong></p>
<h3 id="nextæ–¹æ³•ä¸Iteratoræ¥å£"><a href="#nextæ–¹æ³•ä¸Iteratoræ¥å£" class="headerlink" title="nextæ–¹æ³•ä¸Iteratoræ¥å£"></a>nextæ–¹æ³•ä¸Iteratoræ¥å£</h3><p><code>Iterator</code>åŒæ ·ä½¿ç”¨nextæ–¹æ³•æ¥éå†å…ƒç´ ã€‚ç”±äºGeneratorå‡½æ•°ä¼šè¿”å›çš„å¯¹è±¡å®ç°äº†ä¸€ä¸ªIteratoræ¥å£ï¼Œå› æ­¤æ‰€æœ‰èƒ½å¤Ÿéå†Iteratoræ¥å£çš„æ–¹æ³•éƒ½å¯ä»¥ç”¨æ¥æ‰§è¡ŒGeneratorï¼Œå¯ä»¥ä½¿ç”¨<code>for / of</code>å¾ªç¯çš„æ–¹å¼æ¥æ‰§è¡ŒGeneratorå‡½æ•°å†…çš„æ­¥éª¤</p>
<p><strong>â—ï¸å¾ªç¯ä¼šåœ¨<code>done</code>å±æ€§ä¸º<code>true</code>æ—¶åœæ­¢ï¼Œä¹‹å‰ä¾‹å­ä¸­çš„<code>end</code>å¹¶ä¸ä¼šè¢«æ‰“å°ï¼Œå¦‚æœå¸Œæœ›è¢«æ‰“å°ï¼Œéœ€è¦å°†æœ€åçš„<code>return</code>æ”¹ä¸º<code>yield</code></strong></p>
<pre><code class="javascript">function * Generator() {
    yield &#39;hello, world&#39;
    yield &#39;0xGeekCat&#39;
    return &#39;end&#39;
}

var gen = Generator()

for (let i of gen) {
    console.log(i)
}

console.log(Array.from(Generator())) ğŸ‘ˆ å°†Generator()è½¬æ¢æˆæ•°ç»„ï¼Œä¸è¿‡ä¼¼ä¹å…¶ä¸æ˜¯array-like Object</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2011.png" alt="screenshot 11"></p>
<p>ç›´æ¥æ‰“å°Generatorå‡½æ•°çš„ç¤ºä¾‹æ²¡æœ‰ç»“æœï¼Œä½†æ—¢ç„¶Generatorå‡½æ•°è¿”å›äº†ä¸€ä¸ªéå†å™¨ï¼Œé‚£å°±è‡ªç„¶å…·æœ‰<code>Symbol.iterator</code>å±æ€§</p>
<pre><code class="javascript">console.log(gen[Symbol.iterator]) // [Function: [Symbol.iterator]]</code></pre>
<h2 id="Generatorä¸­çš„é”™è¯¯å¤„ç†"><a href="#Generatorä¸­çš„é”™è¯¯å¤„ç†" class="headerlink" title="Generatorä¸­çš„é”™è¯¯å¤„ç†"></a>Generatorä¸­çš„é”™è¯¯å¤„ç†</h2><p>Generatorå‡½æ•°çš„åŸå‹ä¸­å®šä¹‰äº†<code>throw</code>æ–¹æ³•ï¼Œç”¨äºæŠ›å‡ºå¼‚å¸¸</p>
<pre><code class="javascript">function * generator() {
    try {
        yield console.log(&#39;0xGeekCat&#39;)
    } catch (e) {
        console.log(e)
    }

    yield console.log(&#39;Node&#39;)
    return &#39;end&#39;
}

var gen = generator()
gen.next()
gen.throw(&#39;error&#39;)
console.log(gen.next())</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2012.png" alt="screenshot 12"></p>
<p>æ‰§è¡Œå®Œç¬¬ä¸€ä¸ª<code>yield</code>æ“ä½œåï¼ŒGeneratorå¯¹è±¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œç„¶åè¢«å‡½æ•°ä½“ä¸­<code>try / catch</code>æ•è·</p>
<p><strong>â—ï¸å½“å¼‚å¸¸è¢«æ•è·åï¼ŒGeneratorå‡½æ•°ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ª<code>yield</code>æ“ä½œå¹¶è¾“å‡º<code>yield</code>è¡¨è¾¾å¼çš„å€¼</strong></p>
<pre><code class="javascript">function* generator() {
    try {
        yield console.log(&#39;hello, world&#39;)
    } catch (e) {
        console.log(e)
    }

    console.log(&#39;test&#39;)
    yield console.log(&#39;0xGeekCat&#39;)
    return &#39;end&#39;
}

var gen = generator()
gen.next()
gen.throw(&#39;throw error&#39;)</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2013.png" alt="screenshot 13"></p>
<p>å¦‚æœGeneratorå‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¹Ÿå¯ä»¥åœ¨å¤–éƒ¨è¿›è¡Œæ•è·</p>
<pre><code class="javascript">function* generator() {
    yield console.log(undefined.undefined)
}

var gen = generator()

try {
    gen.next()
} catch (e) {
    console.log(e)
}</code></pre>
<p>Generatorçš„åŸå‹å¯¹è±¡è¿˜å®šä¹‰äº†<code>return()</code>æ–¹æ³•ï¼Œç”¨æ¥ç»“æŸGeneratorå‡½æ•°çš„æ‰§è¡Œï¼Œè¿™å’Œå‡½æ•°å†…éƒ¨çš„<code>return</code>å…³é”®å­—ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µ</p>
<pre><code class="javascript">function* generator() {
    yield console.log(&#39;hello, world&#39;)
    yield console.log(&#39;0xGeekCat&#39;)
    return &#39;end&#39;
}

var gen = generator()
gen.next()
gen.return() ğŸ‘ˆ ä¹‹åçš„nextä¸ä¼šè¢«æ‰§è¡Œ
gen.next()</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2014.png" alt="screenshot 14"></p>
<h2 id="ç”¨Generatorç»„ç»‡å¼‚æ­¥æ–¹æ³•"><a href="#ç”¨Generatorç»„ç»‡å¼‚æ­¥æ–¹æ³•" class="headerlink" title="ç”¨Generatorç»„ç»‡å¼‚æ­¥æ–¹æ³•"></a>ç”¨Generatorç»„ç»‡å¼‚æ­¥æ–¹æ³•</h2><p><strong>ä½¿ç”¨Generatorå‡½æ•°å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„åŸå› </strong></p>
<ul>
<li>Generatorå‡½æ•°å¯ä»¥ä¸­æ–­å’Œæ¢å¤æ‰§è¡Œï¼Œè¿™ä¸ªç‰¹æ€§ç”±<code>yield</code>å…³é”®å­—æ¥å®ç°</li>
<li>Generatorå‡½æ•°å†…å¤–å¯ä»¥äº¤æ¢æ•°æ®ï¼Œè¿™ä¸ªç‰¹æ€§ç”±<code>next</code>å‡½æ•°æ¥å®ç°</li>
</ul>
<p><strong>Generatorå‡½æ•°å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæ€æƒ³</strong></p>
<p>å…ˆå°†å‡½æ•°æš‚åœåœ¨æŸå¤„ï¼Œç„¶åæ‹¿åˆ°å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œç„¶åå†æŠŠè¿™ä¸ªç»“æœä¼ åˆ°æ–¹æ³•ä½“å†…</p>
<p>yieldå…³é”®å­—åé¢é™¤äº†é€šå¸¸çš„å‡½æ•°è¡¨è¾¾å¼å¤–ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯åé¢è·Ÿçš„æ˜¯ä¸€ä¸ªPromiseï¼Œç”±äºyieldå…³é”®å­—ä¼šå¯¹å…¶åçš„è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼å¹¶è¿”å›ï¼Œé‚£ä¹ˆè°ƒç”¨nextæ–¹æ³•æ—¶å°±ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¯ä»¥æ¥ç€è°ƒç”¨thenæ–¹æ³•ï¼Œå¹¶åœ¨å›è°ƒä¸­ä½¿ç”¨nextæ–¹æ³•å°†ç»“æœä¼ å›Generator</p>
<p><strong>ä½¿ç”¨Generatorå¤„ç†å¼‚æ­¥</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function readFile_promise(path) {
    return new Promise(function (resolve, reject) {
        fs.readFile(path, &#39;utf-8&#39;, function (error, data) {
            if (data) {
                resolve(data)
            } else {
                reject(error)
            }
        })
    })
}

function* generator() {
    var result = yield readFile_promise(&#39;foo.txt&#39;)
    console.log(result)
}

var gen = generator()
var result = gen.next() ğŸ‘ˆ resultå¯¹è±¡ä¸­å«æœ‰Promiseå¯¹è±¡
console.log(result)
result.value.then(function (data) { 
    gen.next(data)
})</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2015.png" alt="screenshot 15"></p>
<p>ğŸ‘†Generatorå‡½æ•°å°è£…<code>readFile_promise</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseï¼ŒGeneratorå‡½æ•°å¯¹<code>readFile_promise</code>çš„è°ƒç”¨æ–¹å¼å’ŒåŒæ­¥æ“ä½œåŸºæœ¬ç›¸åŒï¼Œé™¤äº†yieldå…³é”®å­—ä¹‹å¤–</p>
<p><strong>ä½¿ç”¨Generatorè¿›è¡Œå¤šä¸ªå¼‚æ­¥æµç¨‹æ§åˆ¶</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)

function readFile_promise(path) {
    return new Promise(function (resolve, reject) {
        fs.readFile(path, &#39;utf-8&#39;, function (error, data) {
            if (data) {
                resolve(data)
            } else {
                reject(error)
            }
        })
    })
}

function* generator() {
    var result = yield readFile_promise(&#39;foo.txt&#39;)
    console.log(result)

    var result2 = yield readFile_promise(&#39;bar.txt&#39;)
    console.log(result2)
}

var gen = generator()
var result = gen.next()
console.log(result)
result.value.then(function (data) {
    gen.next(data).value.then(function (data) {
        gen.next(data)
    })
})</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2016.png" alt="screenshot 16"></p>
<p><strong>Generatorçš„ç¼ºç‚¹</strong></p>
<p>è™½ç„¶åœ¨è°ƒç”¨æ—¶ä¿æŒäº†åŒæ­¥å½¢å¼ï¼Œä½†éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒGeneratorå‡½æ•°ï¼Œäºæ˜¯åœ¨æ‰§è¡Œæ—¶åˆå›åˆ°äº†åµŒå¥—è°ƒç”¨</p>
<h2 id="Generatorçš„è‡ªåŠ¨æ‰§è¡Œ"><a href="#Generatorçš„è‡ªåŠ¨æ‰§è¡Œ" class="headerlink" title="Generatorçš„è‡ªåŠ¨æ‰§è¡Œ"></a>Generatorçš„è‡ªåŠ¨æ‰§è¡Œ</h2><p>å¼€å‘è€…è‚¯å®šä¸å¸Œæœ›è°ƒç”¨å‡½æ•°è¿˜è¦ä¸€æ­¥æ­¥åœ°å†™ä»£ç ã€‚å¯¹Generatorå‡½æ•°æ¥è¯´ï¼Œå¦‚æœè¦é¡ºåºåœ°è¯»å–å¤šä¸ªæ–‡ä»¶ï¼Œä¹Ÿè¦å†™å¾ˆå¤šç”¨æ¥æ‰§è¡Œçš„ä»£ç </p>
<p>æ— è®ºæ˜¯Promiseè¿˜æ˜¯Generatorï¼Œå°±ç®—åœ¨ç¼–å†™å¼‚æ­¥ä»£ç æ—¶èƒ½è·å¾—ä¾¿åˆ©ï¼Œä½†æ‰§è¡Œé˜¶æ®µå´è¦å†™æ›´å¤šçš„ä»£ç </p>
<ul>
<li>Promiseéœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>then</code>æ–¹æ³•</li>
<li>Generatoréœ€è¦æ‰‹åŠ¨è°ƒç”¨<code>next</code>æ–¹æ³•</li>
</ul>
<p>å½“éœ€è¦é¡ºåºæ‰§è¡Œå¼‚æ­¥æ“ä½œçš„ä¸ªæ•°æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå¼€å‘è€…è¿˜å¯ä»¥æ¥å—æ‰‹åŠ¨æ‰§è¡Œï¼Œä½†å¦‚æœé¢å¯¹å¤šä¸ªå¼‚æ­¥æ“ä½œå°±æœ‰äº›éš¾åŠï¼Œé¿å…äº†<strong>å›è°ƒåœ°ç‹±</strong>ï¼Œå´åˆé™·åˆ°äº†<strong>æ‰§è¡Œåœ°ç‹±</strong></p>
<h3 id="è‡ªåŠ¨æ‰§è¡Œå™¨çš„å®ç°"><a href="#è‡ªåŠ¨æ‰§è¡Œå™¨çš„å®ç°" class="headerlink" title="è‡ªåŠ¨æ‰§è¡Œå™¨çš„å®ç°"></a>è‡ªåŠ¨æ‰§è¡Œå™¨çš„å®ç°</h3><p>æ—¢ç„¶Generatorå‡½æ•°æ˜¯ä¾é nextæ–¹æ³•æ¥æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆåªè¦å®ç°å‡½æ•°è‡ªåŠ¨æ‰§è¡Œnextæ–¹æ³•å°±å¯ä»¥</p>
<pre><code class="javascript">function auto(Generator) {
    var gen = Generator()

    while (gen.next().value !== undefined) {
        gen.next()
    }
}</code></pre>
<p>ğŸ‘†æ€è·¯è™½ç„¶æ²¡é”™ï¼Œä½†è¿™ç§å†™æ³•å¹¶ä¸æ­£ç¡®ï¼Œé¦–å…ˆè¿™ç§æ–¹æ³•åªèƒ½ç”¨åœ¨åƒğŸ‘‡è¿™ç§æœ€ç®€å•çš„Generatorå‡½æ•°ä¸Š</p>
<pre><code class="javascript">function* Generator() {
    yield &#39;0xGeekCat&#39;
    return &#39;end&#39;
}</code></pre>
<p>å¦ä¸€æ–¹é¢ï¼Œç”±äºGeneratoræ²¡æœ‰<code>hasNext</code>æ–¹æ³•ï¼Œ<code>gen.next().value !== undefined</code>åœ¨whileå¾ªç¯ä¸­ä½œä¸ºæ¡ä»¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ¡ä»¶åˆ¤æ–­æ—¶å°±å¼€å§‹æ‰§è¡Œäº†ï¼Œè¿™è¡¨ç¤ºæ— æ³•æ‹¿åˆ°ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„ç»“æœã€‚å› æ­¤è¿™ç§å†™æ³•è¡Œä¸é€šï¼Œäºæ˜¯æ¢ä¸ªæ€è·¯</p>
<pre><code class="javascript">function* Generator() {
    yield &#39;0xGeekCat&#39;
    yield &#39;hello, world&#39;
    return &#39;end&#39;
}


var gen = Generator()
for (let i of gen) {
    console.log(i)
}</code></pre>
<p><code>for / of</code>å¾ªç¯çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†åŒæ ·ä¹Ÿåªèƒ½æ‹¿æ¥æ‰§è¡Œæœ€ç®€å•çš„Generatorå‡½æ•°</p>
<h3 id="åŸºäºPromiseçš„æ‰§è¡Œå™¨"><a href="#åŸºäºPromiseçš„æ‰§è¡Œå™¨" class="headerlink" title="åŸºäºPromiseçš„æ‰§è¡Œå™¨"></a>åŸºäºPromiseçš„æ‰§è¡Œå™¨</h3><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œyieldåé¢è·Ÿçš„å¤§éƒ½æ˜¯Promiseï¼Œè¿™æ—¶å€™<code>for / of</code>å®ç°çš„æ‰§è¡Œå™¨å°±ä¸èµ·ä½œç”¨</p>
<p>è§‚å¯Ÿå‘ç°Generatorçš„åµŒå¥—æ‰§è¡Œæ˜¯ä¸€ç§é€’å½’è°ƒç”¨ï¼Œæ¯ä¸€æ¬¡çš„åµŒå¥—çš„è¿”å›ç»“æœéƒ½æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡</p>
<p><strong>å‡çº§åçš„æ‰§è¡Œå‡½æ•°</strong></p>
<pre><code class="javascript">function auto_exec(gen) {
    function next(data) {
        var result = gen.next(data)

        if (result.done)
            return result.value

        result.value.then(function (data) {
            next(data)
        })
    }

    next()
}</code></pre>
<p>è¿™ä¸ªæ‰§è¡Œå™¨å› ä¸ºè°ƒç”¨<code>then</code>æ–¹æ³•ï¼Œå› æ­¤åªé€‚ç”¨äº<code>yield</code>åé¢è·Ÿä¸€ä¸ªPromiseçš„æ–¹æ³•</p>
<h3 id="ä½¿ç”¨coæ¨¡å—æ¥è‡ªåŠ¨æ‰§è¡Œ"><a href="#ä½¿ç”¨coæ¨¡å—æ¥è‡ªåŠ¨æ‰§è¡Œ" class="headerlink" title="ä½¿ç”¨coæ¨¡å—æ¥è‡ªåŠ¨æ‰§è¡Œ"></a>ä½¿ç”¨coæ¨¡å—æ¥è‡ªåŠ¨æ‰§è¡Œ</h3><p>ä¸ºäº†è§£å†³generatoræ‰§è¡Œçš„é—®é¢˜ï¼Œ2013å¹´6æœˆå‘å¸ƒäº†è‘—åcoæ¨¡å—ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥è‡ªåŠ¨æ‰§è¡ŒGeneratorå‡½æ•°çš„å°å·¥å…·ï¼Œå’ŒGeneratoré…åˆå¯ä»¥å®ç°æ¥è¿‘åŒæ­¥çš„è°ƒç”¨æ–¹å¼ï¼Œcoæ–¹æ³•ä»ç„¶ä¼šè¿”å›ä¸€ä¸ªPromise</p>
<p><strong>ä½¿ç”¨coæ¨¡å—æ‰§è¡ŒGenerator</strong></p>
<pre><code class="javascript">var fs = require(&#39;fs&#39;)
var co = require(&#39;co&#39;)

function readFile_promise(path) {
    return new Promise(function (resolve, reject) {
        fs.readFile(path, &#39;utf-8&#39;, function (error, data) {
            if (data) {
                resolve(data)
            } else {
                reject(error)
            }
        })
    })
}

function* gen() {
    var result = yield readFile_promise(&#39;foo.txt&#39;)
    console.log(result)

    var result2 = yield readFile_promise(&#39;bar.txt&#39;)
    console.log(result2)
}

co(gen)</code></pre>
<p>åªè¦å°†Generatorå‡½æ•°ä½œä¸ºå‚æ•°ä¼ ç»™coæ–¹æ³•å°±èƒ½å°†å†…éƒ¨çš„å¼‚æ­¥ä»»åŠ¡é¡ºåºæ‰§è¡Œ</p>
<p><strong>â—ï¸è¦ä½¿ç”¨coæ¨¡å—ï¼Œyieldåé¢çš„è¯­å¥åªèƒ½æ˜¯promsieå¯¹è±¡</strong></p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå¯¹å¼‚æ­¥çš„å¤„ç†æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒå¦¥å½“çš„æ–¹å¼ï¼Œåˆ©ç”¨<code>generator + co</code>ï¼ŒåŸºæœ¬å¯ä»¥ç”¨åŒæ­¥çš„æ–¹å¼æ¥ä¹¦å†™å¼‚æ­¥æ“ä½œ</p>
<p>ä½†coæ¨¡å—ä»æœ‰ä¸è¶³ä¹‹å¤„ï¼Œç”±äºå®ƒä»ç„¶è¿”å›Promiseï¼Œè¿™ä»£è¡¨å¦‚æœæƒ³è¦è·å¾—å¼‚æ­¥æ–¹æ³•çš„è¿”å›å€¼ï¼Œè¿˜è¦ğŸ‘‡è¿™ç§å½¢å¼</p>
<pre><code class="javascript">co(gen).then(function (value) {
    console.log(value)
})</code></pre>
<p>å¦å¤–å½“é¢å¯¹å¤šä¸ªå¼‚æ­¥æ“ä½œæ—¶ï¼Œé™¤éå°†æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œéƒ½æ”¾åœ¨ä¸€ä¸ªGeneratorå‡½æ•°ä¸­ï¼Œå¦åˆ™å¦‚æœéœ€è¦å¯¹coçš„è¿”å›å€¼è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œï¼Œä»ç„¶è¦å°†ä»£ç å†™åˆ°Promiseçš„å›è°ƒä¸­å»</p>
<h1 id="å›è°ƒçš„ç»ˆç‚¹-async-await"><a href="#å›è°ƒçš„ç»ˆç‚¹-async-await" class="headerlink" title="å›è°ƒçš„ç»ˆç‚¹ async / await"></a>å›è°ƒçš„ç»ˆç‚¹ async / await</h1><h2 id="asyncå‡½æ•°çš„æ¦‚å¿µ"><a href="#asyncå‡½æ•°çš„æ¦‚å¿µ" class="headerlink" title="asyncå‡½æ•°çš„æ¦‚å¿µ"></a>asyncå‡½æ•°çš„æ¦‚å¿µ</h2><p>ES2017æ ‡å‡†å¼•å…¥asyncå‡½æ•°ï¼Œç»ˆç»“äº†å›è°ƒå¤„ç†çš„é—®é¢˜ï¼Œ<strong>asyncå‡½æ•°å¯ä»¥çœ‹ä½œæ˜¯è‡ªå¸¦æ‰§è¡Œå™¨çš„Generatorå‡½æ•°</strong></p>
<p><strong>ç”¨asyncå‡½æ•°æ”¹å†™Generatoræ–¹æ³•</strong></p>
<pre><code class="javascript">function* gen() {
    var result = yield readFile_promise(&#39;foo.txt&#39;)
    console.log(result)

    var result2 = yield readFile_promise(&#39;bar.txt&#39;)
    console.log(result2)
}
ğŸ‘‡ ç­‰æ•ˆ
var asyncReadFile = async function() {
    var result = readFile_promise(&#39;foo.txt&#39;)
    console.log(result)

    var result2 = readFile_promise(&#39;bar.txt&#39;)
    console.log(result2)
}</code></pre>
<p>å½¢å¼çœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆå¤§çš„å˜åŒ–ï¼Œyieldå…³é”®å­—æ¢æˆäº†awaitï¼Œæ–¹æ³•åå‰çš„*å·å˜æˆäº†asyncå…³é”®å­—</p>
<p><strong>Generatorå’Œasyncçš„åŒºåˆ«</strong></p>
<ul>
<li>awaitåé¢å¾€å¾€æ˜¯Promiseï¼Œå¦‚æœä¸æ˜¯å°±éšå¼è°ƒç”¨<code>promise.resolve</code>è½¬æ¢æˆPromiseï¼Œ<strong>awaitä¼šç­‰å¾…åé¢çš„Promiseæ‰§è¡Œå®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</strong></li>
<li>è°ƒç”¨asyncæ–¹æ³•æ˜¯ç›´æ¥é€šè¿‡æ–¹æ³•åè°ƒç”¨</li>
</ul>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®Œå…¨æ²¡æœ‰äº†å›è°ƒçš„å½±å­ä¹Ÿæ²¡æœ‰å¼•å…¥ä»»ä½•ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œasyncæ‹¥æœ‰Nodeçš„åŸç”Ÿæ”¯æŒï¼Œå›°æ‰°Nodeç¤¾åŒºå¤šå¹´çš„å›è°ƒé—®é¢˜åœ¨è¿™é‡Œç»ˆç»“</p>
<h3 id="å£°æ˜asyncæ–¹æ³•"><a href="#å£°æ˜asyncæ–¹æ³•" class="headerlink" title="å£°æ˜asyncæ–¹æ³•"></a>å£°æ˜asyncæ–¹æ³•</h3><pre><code class="javascript">// æ™®é€šå‡½æ•°å£°æ˜
async function foo() {}

// å‡½æ•°è¡¨è¾¾å¼
const foo = async function() {}

// ç®­å¤´å‡½æ•°
const foo = async () =&gt; {}</code></pre>
<h3 id="asyncçš„è¿”å›å€¼"><a href="#asyncçš„è¿”å›å€¼" class="headerlink" title="asyncçš„è¿”å›å€¼"></a>asyncçš„è¿”å›å€¼</h3><p>asyncå‡½æ•°æ€»æ˜¯ä¼šè¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¦‚æœreturnå…³é”®å­—åé¢ä¸æ˜¯ä¸€ä¸ªPromiseï¼Œé‚£ä¹ˆé»˜è®¤è°ƒç”¨<code>promise.resolve</code>æ–¹æ³•è¿›è¡Œè½¬æ¢</p>
<pre><code class="javascript">async function asyncFunc() {
    return &#39;0xGeekCat&#39;
}

asyncFunc().then(function (data) {
    console.log(data) // 0xGeekCat
})

console.log(asyncFunc()) // Promise { &#39;0xGeekCat&#39; }</code></pre>
<p><code>asyncFunc()</code>æ–¹æ³•è™½ç„¶çœ‹ä¼¼è¿”å›äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå´ä½¿ç”¨thenæ–¹æ³•æ¥è·å¾—å€¼ï¼Œè¿™æ˜¯å†…éƒ¨å°†å­—ç¬¦ä¸²è½¬æ¢æˆäº†Promiseçš„ç¼˜æ•…</p>
<h3 id="asyncå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#asyncå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="asyncå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹"></a>asyncå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹</h3><ul>
<li>åœ¨asyncå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªPromiseå¯¹è±¡</li>
<li>å½“æ–¹æ³•ä½“å¼€å§‹æ‰§è¡Œåï¼Œå¦‚æœé‡åˆ°returnå…³é”®å­—æˆ–è€…throwå…³é”®å­—ï¼Œæ‰§è¡Œä¼šç«‹åˆ»é€€å‡ºï¼Œå¦‚æœé‡åˆ°awaitå…³é”®å­—åˆ™ä¼šæš‚åœæ‰§è¡Œï¼Œawaitåé¢çš„å¼‚æ­¥æ“ä½œç»“æŸåä¼šæ¢å¤æ‰§è¡Œ</li>
<li>æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ä¸€ä¸ªPromise</li>
</ul>
<p><strong>é€šè¿‡ğŸ‘‡ä¾‹å­äº†è§£asyncå‡½æ•°å·¥ä½œæµç¨‹</strong></p>
<pre><code class="javascript">async function asyncFunc() {
    console.log(&#39;begin&#39;)
    return &#39;0xGeekCat&#39;
}

asyncFunc().then(x =&gt; console.log(x))

setTimeout(function () {
    console.log(&#39;end&#39;)
}, 2000)</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2018.png" alt="screenshot 18"></p>
<pre><code class="javascript">async function asyncFunc() {
    console.log(&#39;begin&#39;)
    return &#39;0xGeekCat&#39;
}

asyncFunc().then(x =&gt; console.log(x))

console.log(&#39;end&#39;)</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2019.png" alt="screenshot 19"></p>
<p>asyncå‡½æ•°è¿”å›çš„Promiseï¼Œæ—¢å¯ä»¥æ˜¯resolvedçŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ˜¯rejectçŠ¶æ€ï¼Œä¸è¿‡é€šå¸¸ä½¿ç”¨<code>throw Error</code>çš„æ–¹å¼æ¥ä»£æ›¿reject</p>
<pre><code class="javascript">async function asyncFunc() {
    return Promise.reject(new Error(&#39;0xGeekCat&#39;))
}

asyncFunc().catch(err =&gt; console.log(err))</code></pre>
<h2 id="awaitå…³é”®å­—"><a href="#awaitå…³é”®å­—" class="headerlink" title="awaitå…³é”®å­—"></a>awaitå…³é”®å­—</h2><p>å¯¹äºasyncæ¥è¯´ï¼Œawaitå…³é”®å­—ä¸æ˜¯å¿…éœ€çš„ï¼Œ<strong>ç”±äºasyncæœ¬è´¨ä¸Šæ˜¯å¯¹Promiseçš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨æ‰§è¡ŒPromiseçš„æ–¹æ³•æ¥æ‰§è¡Œasyncæ–¹æ³•</strong></p>
<p><strong>ğŸ””awaitå…³é”®å­—æ˜¯è¿™ä¸€æƒ…å†µçš„è¯­æ³•ç³–ï¼Œå®ƒå¯ä»¥<code>è‡ªåŠ¨æ‰§è¡Œ</code>ä¸€ä¸ªPromise</strong></p>
<p>å…¶å®æ˜¯ç­‰å¾…åé¢çš„Promiseå®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥åŠ¨ä½œï¼Œå½“asyncå‡½æ•°å†…æœ‰å¤šä¸ªPromiseéœ€è¦ä¸²è¡Œæ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ç§ç‰¹æ€§å¸¦æ¥çš„å¥½å¤„æ˜¯ååˆ†æ˜æ˜¾çš„</p>
<p>awaitæ“ä½œç¬¦çš„ç»“æœæ˜¯ç”±å…¶åé¢Promiseå¯¹è±¡çš„æ“ä½œç»“æœæ¥å†³å®šçš„</p>
<ul>
<li>å¦‚æœåé¢Promiseå¯¹è±¡å˜ä¸ºresolvedï¼Œawaitæ“ä½œç¬¦è¿”å›çš„å€¼å°±æ˜¯resolveçš„å€¼</li>
<li>å¦‚æœPromiseå¯¹è±¡çš„çŠ¶æ€å˜æˆrejectedï¼Œé‚£ä¹ˆawaitä¹Ÿä¼šæŠ›å‡ºrejectçš„å€¼</li>
</ul>
<p><strong>å¼‚æ­¥è¯»å–ä¸€ä¸ªæ–‡ä»¶</strong></p>
<pre><code class="javascript">async function readFile() {
    var result = await readFile_promise(&#39;foo.txt&#39;)
    console.log(result)
}
readFile()
ğŸ‘‡ ç­‰æ•ˆ
readFile_promise(&#39;foo.txt&#39;).then(function (data) {
    console.log(data)
})</code></pre>
<p><strong>ç”±äºawaitå¯ä»¥çœ‹ä½œæ˜¯Promiseçš„æ‰§è¡Œå™¨</strong>ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥å†™æˆğŸ‘‡å½¢å¼</p>
<pre><code class="javascript">async function readFile() {
    var result = await readFile_promise(&#39;foo.txt&#39;).then(function (result) {
        return result
    })
    console.log(result)
}

readFile()</code></pre>
<p>åœ¨ä½¿ç”¨äº†awaitå…³é”®å­—ä¹‹åï¼Œæ— è®ºæ˜¯ä»£ç è¿˜æ˜¯æ‰§è¡Œï¼Œéƒ½å˜å¾—å’ŒåŒæ­¥æ“ä½œæ²¡ä»€ä¹ˆä¸¤æ ·</p>
<h3 id="awaitä¸å¹¶è¡Œ"><a href="#awaitä¸å¹¶è¡Œ" class="headerlink" title="awaitä¸å¹¶è¡Œ"></a>awaitä¸å¹¶è¡Œ</h3><p>awaitä¼šç­‰å¾…åé¢çš„Promiseå®Œæˆåå†é‡‡å–ä¸‹ä¸€æ­¥åŠ¨ä½œï¼Œè¿™æ„å‘³ç€å½“æœ‰å¤šä¸ªawaitæ“ä½œæ—¶ï¼Œç¨‹åºä¼šå˜æˆå®Œå…¨çš„ä¸²è¡Œæ“ä½œ</p>
<p><strong>ä¸ºäº†å‘æŒ¥Nodeçš„å¼‚æ­¥ä¼˜åŠ¿ï¼Œå½“å¼‚æ­¥æ“ä½œä¹‹é—´ä¸å­˜åœ¨ç»“æœçš„ä¾èµ–å…³ç³»æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>promise.all</code>æ¥å®ç°å¹¶è¡Œ</strong></p>
<pre><code class="javascript">async function readFile() {
    const [result1, result2] = await Promise.all([
        readFile_promise(&#39;foo.txt&#39;),
        readFile_promise(&#39;bar.txt&#39;)
    ])

    console.log(result1, result2)
}
ğŸ‘‡ ç­‰æ•ˆ
function readFile() {
    return Promise.all([
        readFile_promise(&#39;foo.txt&#39;),
        readFile_promise(&#39;bar.txt&#39;)
    ]).then((result) =&gt; {
        console.log(result)
    })
}</code></pre>
<h3 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h3><p>å½“asyncå‡½æ•°ä¸­æœ‰å¤šä¸ªawaitå…³é”®å­—æ—¶ï¼Œå¦‚æœæœ‰ä¸€ä¸ªawaitçš„çŠ¶æ€å˜æˆäº†<code>rejected</code>ï¼Œé‚£ä¹ˆåé¢çš„æ“ä½œå°±ä¸ä¼šç»§ç»­æ‰§è¡Œ</p>
<pre><code class="javascript">var asyncReadFile = async function() {
    var result1 = await readFile_promise(&#39;not exist&#39;)
    var result2 = await readFile_promise(&#39;foo.txt&#39;)

    console.log(result1.toString())
    console.log(result2.toString())
}

asyncReadFile()</code></pre>
<p><img src="%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%B9%A6%E5%86%99%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81/screenshot%2017.png" alt="screenshot 17"></p>
<p>ğŸ‘†è¡¨æ˜ä»£ç ä¸­æœ‰æ²¡æœ‰è¢«å¤„ç†çš„å¤„äºrejectedçŠ¶æ€çš„Promiseã€‚å› æ­¤ä½¿ç”¨awaitæ—¶ä¸ºäº†é¿å…æ½œåœ¨çš„é”™è¯¯ï¼Œæœ€å¥½ç”¨<code>try / catch</code>å°†æ‰€æœ‰çš„awaitåŒ…è£¹èµ·æ¥</p>
<h2 id="åœ¨å¾ªç¯ä¸­ä½¿ç”¨asyncæ–¹æ³•"><a href="#åœ¨å¾ªç¯ä¸­ä½¿ç”¨asyncæ–¹æ³•" class="headerlink" title="åœ¨å¾ªç¯ä¸­ä½¿ç”¨asyncæ–¹æ³•"></a>åœ¨å¾ªç¯ä¸­ä½¿ç”¨asyncæ–¹æ³•</h2><p><strong><code>for / while</code>å¾ªç¯</strong></p>
<pre><code class="javascript">var array = [&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;]
async function readFile() {
    for (let i = 0; i &lt; 3; i ++) {
        var result = await readFile_promise(array[i])
        console.log(result)
    }
}

readFile()</code></pre>
<p><strong><code>forEach</code>å¾ªç¯</strong></p>
<pre><code class="javascript">async function readFile(list) {
    list.forEach(async function (item) {
        var result = await readFile_promise(item)
        console.log(result)
    })
}

readFile([&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;])</code></pre>
<p>â—ï¸å³ä½¿æ˜¯åœ¨åŒ¿åå‡½æ•°ä¸­ä½¿ç”¨awaitå…³é”®å­—ï¼Œä¹Ÿè¦åœ¨åŒ¿åå‡½æ•°å‰åŠ ä¸Šasyncå…³é”®å­—</p>
<p><strong><code>for \ of</code>å¾ªç¯</strong></p>
<pre><code class="javascript">async function readFile(list) {
    for (const item of list) {
        var result = await readFile_promise(item)
        console.log(result)
    }
}

readFile([&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;])</code></pre>
<p>å¦‚æœå¼‚æ­¥æ–¹æ³•çš„æ‰§è¡Œå…¨éƒ½å˜æˆä¸²è¡Œçš„è¯ï¼Œå°±ä¸èƒ½å‘æŒ¥å‡ºNodeéé˜»å¡IOçš„ä¼˜åŠ¿äº†ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨å¹¶è¡Œæ¥æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨<code>promise.all</code></p>
<pre><code class="javascript">async function readFile(list) {
    await Promise.all(list.map(async function (item) {
        var result = await readFile_promise(item)
        console.log(result)
    }))
}

readFile([&#39;foo.txt&#39;, &#39;bar.txt&#39;, &#39;baz.txt&#39;])</code></pre>
<h2 id="asyncå’Œawaitå°ç»“"><a href="#asyncå’Œawaitå°ç»“" class="headerlink" title="asyncå’Œawaitå°ç»“"></a>asyncå’Œawaitå°ç»“</h2><p>asyncå‡½æ•°æ˜¯ç”¨<code>async / await</code>å…³é”®å­—æ¥æ ‡è¯†çš„ï¼Œasyncå‡½æ•°è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå½“åœ¨æ–¹æ³•ä½“ä¸­é‡åˆ°å¼‚æ­¥æ“ä½œæ—¶ï¼Œä¼šç«‹åˆ»è¿”å›ï¼Œéšåä¸æ–­è½®è¯¢ç›´åˆ°å¼‚æ­¥æ“ä½œå®Œæˆï¼Œéšåå†ç»§ç»­æ‰§è¡Œæ–¹æ³•ä½“å†…å‰©ä¸‹çš„ä»£ç </p>
<pre><code class="javascript">async function timeout(ms) {
    await new Promise(resolve =&gt; {
        setTimeout(resolve, ms)
    })
}

async function asyncPrint(ms) {
    for (let i = 0; i &lt; 5; i ++) {
        await timeout(ms)
        console.log(i)
    }
}

asyncPrint(1000)</code></pre>
<p>â—ï¸å³ä½¿å°†<code>timeout</code>å†™æˆäº†<code>async / await</code>å½¢å¼ï¼Œä½†åœ¨<code>asyncPrint</code>æ–¹æ³•ä¸­ä¾ç„¶éœ€è¦ä½¿ç”¨<code>await</code>å…³é”®å­—æ¥è°ƒç”¨ï¼ŒåŒæ—¶ä¹Ÿè¯è®©<code>asyncPrint</code>å‡½æ•°å¸¦ä¸Š<code>async</code>å…³é”®å­—</p>
<p>é€šå¸¸åœ¨åªè¦å‡½æ•°ä½“ä¸­è°ƒç”¨asyncæ“ä½œï¼Œè¯¥å‡½æ•°å°±ä¸å¾—ä¸å¸¦ä¸Šasyncå…³é”®å­—ã€‚è¿™æœ‰å¯èƒ½å¯¼è‡´æ‰€æœ‰çš„å‡½æ•°éƒ½å˜æˆasyncå‡½æ•°ï¼Œå°±åƒé‡‡ç”¨åŒæ­¥äº‹ä»¶å¤„ç†çš„è¯­è¨€ä¸€æ ·</p>
<p><strong>å¯¹äºawaitå…³é”®å­—ä½¿ç”¨çš„ä¸€äº›å…³é”®ç‚¹</strong></p>
<ul>
<li>awaitå…³é”®å­—å¿…é¡»ä½äºasyncå‡½æ•°å†…éƒ¨</li>
<li>awaitå…³é”®å­—åé¢éœ€è¦æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œä¸æ˜¯çš„è¯å°±è°ƒç”¨resolveè½¬æ¢</li>
<li>awaitå…³é”®å­—çš„è¿”å›ç»“æœå°±æ˜¯å…¶åé¢Promiseæ‰§è¡Œçš„ç»“æœï¼Œå¯èƒ½æ˜¯resolvedæˆ–è€…rejectedçš„å€¼</li>
<li>ä¸èƒ½åœ¨æ™®é€šç®­å¤´å‡½æ•°ä¸­ä½¿ç”¨awaitå…³é”®å­—ï¼Œéœ€è¦åœ¨ç®­å¤´å‡½æ•°å‰é¢å¢åŠ asyncå…³é”®å­—</li>
<li>awaitç”¨æ¥ä¸²è¡Œåœ°æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œæƒ³å®ç°å¹¶è¡Œå¯ä»¥è€ƒè™‘<code>promise.all</code></li>
</ul>
<h2 id="asyncå‡½æ•°çš„ç¼ºç‚¹"><a href="#asyncå‡½æ•°çš„ç¼ºç‚¹" class="headerlink" title="asyncå‡½æ•°çš„ç¼ºç‚¹"></a>asyncå‡½æ•°çš„ç¼ºç‚¹</h2><p>asyncå‡½æ•°å’ŒGeneratorå‡½æ•°æ¯”èµ·æ¥ï¼Œæœ‰ç€ä¸å°‘çš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚å¯ä»¥å®ç°è‡ªåŠ¨æ‰§è¡Œï¼Œæ— é¡»å€ŸåŠ©ç¬¬ä¸‰æ–¹æ¨¡å—ç­‰ï¼Œä¹Ÿå…å»äº†Generatorå‡½æ•°ä¸­ä¸€äº›å¤æ‚çš„æ¦‚å¿µï¼Œasyncå‡½æ•°çš„å£°æ˜å’Œæ‰§è¡Œä¸æ™®é€šåŒæ­¥å‡½æ•°å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œé™¤äº†asyncå’Œawaitå…³é”®å­—ï¼Œä½†ä»ç„¶æœ‰ä¸€äº›ä¸è¶³ï¼Œå¦‚æœæœ‰å¾ˆå¤šå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€åº•å±‚çš„å¼‚æ­¥æ“ä½œè¢«å°è£…æˆäº†asyncæ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°çš„æ‰€æœ‰ä¸Šå±‚æ–¹æ³•å¯èƒ½éƒ½è¦å˜æˆasyncæ–¹æ³•</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªgetæ–¹æ³•ï¼Œç”¨æ¥ä»æ•°æ®åº“ä¸­æ‰¾å‡ºä¸€æ¡idæœ€å¤§å€¼çš„è®°å½•ï¼Œç„¶åè°ƒç”¨setæ–¹æ³•å°†è¿™ä¸ªå€¼å¢åŠ 1åå­˜å…¥æ•°æ®åº“ï¼Œç„¶åå†è¿”å›ä¿®æ”¹åçš„å€¼</p>
<pre><code class="javascript">async function update() {
    var value = await get()
    ++ value

    await set()
    // åº”è¯¥ç­‰å¾…setç»“æŸå†è¿”å›
    return value
}</code></pre>
<p>å‡è®¾updateæ˜¯ç”±ä¸€ä¸ªå¯¹è±¡è§¦å‘updateäº‹ä»¶æ—¶æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸Šä¸€çº§çš„è°ƒç”¨ä¼šæ˜¯ğŸ‘‡å½¢å¼</p>
<pre><code class="javascript">obj.on(&#39;update&#39;, function () {
    var value = update()
})</code></pre>
<p>å¯¹äºasyncå‡½æ•°updateæ¥è¯´ï¼Œè¿™ç§è°ƒç”¨å¾—ä¸åˆ°æ­£ç¡®çš„valueå€¼ï¼Œ<strong>ğŸ””å› ä¸ºasyncæ–¹æ³•è¿”å›çš„æ°¸è¿œæ˜¯Promise</strong>ï¼Œå³ä½¿å¼€å‘è€…è¿”å›çš„æ˜¯å¸¸é‡ï¼Œä¹Ÿä¼šè¢«è‡ªåŠ¨è°ƒç”¨çš„<code>promise.resolve</code>æ–¹æ³•è½¬æ¢ä¸ºPromiseï¼Œå› æ­¤ä¸Šå±‚çš„è°ƒç”¨æ–¹æ³•ä¹Ÿè¦æ˜¯asyncå‡½æ•°</p>
<pre><code class="javascript">async function xxx() {
    var value = await update()
    return value
}</code></pre>
<p>å¦‚æœè¿˜å­˜åœ¨æ›´é«˜å±‚æ¬¡çš„æ–¹æ³•è°ƒç”¨ï¼Œé‚£ä¹ˆä»æœ€åº•å±‚çš„å¼‚æ­¥æ“ä½œå¼€å§‹ï¼Œåˆ°æœ€é¡¶å±‚ä¸€ä¸ªä¸éœ€è¦è¿”å›å€¼çš„å‡½æ•°ä¸ºæ­¢ï¼Œå…¨éƒ¨çš„æ–¹æ³•éƒ½å˜æˆasyncæ–¹æ³•</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>ã€Šæ–°æ—¶æœŸçš„Node.jså…¥é—¨ã€‹ æé”´</p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">èµ
            <div class="reward-main">
              <ul class="reward-row">
                <li class="wechat-code"><img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/photos/wechat.png"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E4%BD%BF%E7%94%A8Koa2%E6%9E%84%E5%BB%BAWeb%E7%AB%99%E7%82%B9.html" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.1/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                ã€Šæ–°æ—¶æœŸçš„Node.jså…¥é—¨ã€‹å­¦ä¹ æ—¥è®°-ä½¿ç”¨Koa2æ„å»ºWebç«™ç‚¹</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/%E3%80%8A%E6%96%B0%E6%97%B6%E6%9C%9F%E7%9A%84Node-js%E5%85%A5%E9%97%A8%E3%80%8B%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0-%E7%94%A8ES6%E4%B9%A6%E5%86%99Node.html" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.1/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                ã€Šæ–°æ—¶æœŸçš„Node.jså…¥é—¨ã€‹å­¦ä¹ æ—¥è®°-ç”¨ES6ä¹¦å†™Node</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "GyC3NzMvd0hT9Yyd2hYIC0MN-gzGzoHsz",
        appKey: "mgOpfzbkHYqU92CV4IDlAUHQ",
        path: window.location.pathname,
        placeholder: "ä½ æ˜¯æˆ‘ä¸€ç”Ÿåªä¼šé‡è§ä¸€æ¬¡çš„æƒŠå–œ ..."
      })
  }
</script>

      <section class="author-profile">
        <div class="info" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
          <a href="https://0xgeekcat.github.io/" class="profile gravatar"><img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/custom/avatar.jpg" itemprop="image" alt="0xGeekCat" height="70" width="70"></a>
          <div class="meta">
            <span class="title">Author</span>
            <h3 itemprop="name">
            <a href="https://0xgeekcat.github.io/" itemprop="url" rel="author">0xGeekCat</a>
            </h3>
          </div>
        </div>
        <hr>
        <p><i class="iconfont icon-write"></i></p>
      </section>
    </main><!-- #main -->
  </div><!-- #primary -->
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="è¯·è¾“å…¥å…³é”®è¯..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            // PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 0xGeekCat<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- ä¸è’œå­ ç½‘é¡µè®¡æ•°å™¨ -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.1","name":"/video/The-Pet-Girl-of-Sakurasou.mp4","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.1","name":"/video/The-Pet-Girl-of-Sakurasou.mp4","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //æœ‰å›¾çš„æƒ…å†µ
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // æ”¾ç½®ç›®å½•çš„å®¹å™¨
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // æ­£æ–‡å†…å®¹æ‰€åœ¨
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // éœ€è¦ç´¢å¼•çš„æ ‡é¢˜çº§åˆ«
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // æ”¾ç½®ç›®å½•çš„å®¹å™¨
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // æ­£æ–‡å†…å®¹æ‰€åœ¨
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // éœ€è¦ç´¢å¼•çš„æ ‡é¢˜çº§åˆ«
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <!-- å®ç°æ¢è‚¤åŠŸèƒ½ -->

  <div class="skin-menu no-select" id="mainskin" style="position: fixed">
 <div class="theme-controls row-container">
  <ul class="menu-list">
   <li id="white-bg"> <i class="fa fa-television" aria-hidden="true"></i></li>
   <li id="sakura-bg"> <i class="iconfont icon-sakura"></i></li>
   <li id="gribs-bg"> <i class="fa fa-slack" aria-hidden="true"></i></li>
   <li id="KAdots-bg"> <i class="iconfont icon-dots"></i></li>
   <li id="totem-bg"> <i class="fa fa-optin-monster" aria-hidden="true"></i></li>
   <li id="pixiv-bg"> <i class="iconfont icon-pixiv"></i></li>
   <li id="bing-bg"> <i class="iconfont icon-bing"></i></li>
   <li id="dark-bg"> <i class="fa fa-moon-o" aria-hidden="true"></i></li>
  </ul>
 </div>
</div>
<canvas id="night-mode-cover"></canvas>

  <div class="changeSkin-gear no-select">

  <div class="keys" id="setbtn"> 

   <span id="open-skinMenu"> åˆ‡æ¢ä¸»é¢˜ | SCHEME TOOL  

     <i class="iconfont icon-gear inline-block rotating"></i> 

   </span>

  </div>

</div>

  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://cdn.jsdelivr.net/gh/0xGeekCat/cdn@2.2/img/custom/avatar.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">MĞ°ĞºÑĞ¸Ğ¼0xGeekCat</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="https://github.com/0xGeekCat" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            é¦–é¡µ
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            å½’æ¡£
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/%E6%8A%80%E6%9C%AF/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  æŠ€æœ¯
                </a>
              </li>
            
              <li>
                <a href="/categories/%E7%94%9F%E6%B4%BB/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  ç”Ÿæ´»
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  è½¬è½½
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            ä¹¦å•
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/%E5%B7%B2%E8%AF%BB/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  å·²è¯»
                </a>
              </li>
            
              <li>
                <a href="/tags/%E6%9C%AA%E8%AF%BB/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  æœªè¯»
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            å…³äº
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  æˆ‘ï¼Ÿ
                </a>
              </li>
            
          </ul>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>
</body>
</html>